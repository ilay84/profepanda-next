{% extends "base.html" %}
{% block title %}Admin · New Page{% endblock %}

{% block admin_nav %}
  {% include "_admin_bar.html" %}
{% endblock %}

{% block content %}
<style>
  /* Use Montserrat for this page (base.css may already do this, but enforce here) */
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
  .pages-wrapper { font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .pages-card {
    max-width: 980px; margin: 1.5rem auto; background: #fff; border: 1px solid #e5e7eb;
    border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06);
  }
  .pages-head {
    padding: 1rem 1.25rem; border-bottom: 1px solid #eef2f7; display:flex; align-items:center; justify-content:space-between;
  }
  .pages-head h1 { font-size: 1.25rem; margin: 0; font-weight: 700; color: #0f172a; }
  .pages-body { padding: 1.25rem; }
  .field { margin-bottom: 1rem; }
  .label { display:block; font-weight:600; margin-bottom:.4rem; color:#334155; }
  .input, .tags-input {
    width:100%; padding:.625rem .75rem; border:1px solid #cbd5e1; border-radius:10px; font-size:1rem; outline:none;
  }
  .input:focus, .tags-input:focus { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15); }
  .help { color:#64748b; font-size:.9rem; margin-top:.25rem; }
  .toolbar-note{ color:#475569; font-size:.9rem; margin:.25rem 0 1rem; }
  .actions { display:flex; gap:.6rem; justify-content:flex-end; border-top:1px solid #eef2f7; padding:1rem 1.25rem; }
  .btn {
    appearance:none; border:0; padding:.65rem 1rem; border-radius:10px; font-weight:600; cursor:pointer;
  }
  .btn.primary { background:#2563eb; color:#fff; }
  .btn.secondary { background:#e2e8f0; color:#0f172a; }
  .success-pill {
    display:none; margin-left:auto; margin-right:.5rem; align-items:center; gap:.4rem;
    padding:.35rem .6rem; border-radius:999px; background:#dcfce7; color:#166534; font-weight:600; font-size:.9rem;
  }
  .success-pill.show{ display:inline-flex; }
</style>

<!-- TinyMCE (rich text editor) -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js" referrerpolicy="origin"></script>

<div class="pages-wrapper">
  <div class="pages-card">
    <div class="pages-head">
      <h1>New Page</h1>
      <span id="saveOk" class="success-pill">✓ Saved</span>
    </div>

    <div class="pages-body">
      <form id="pageForm">
        <!-- Title -->
        <div class="field">
          <label class="label" for="title">Title</label>
          <input class="input" id="title" name="title" type="text" placeholder="Add a page title…" required />
        </div>

        <!-- Tags -->
        <div class="field">
          <label class="label" for="tags">Tags</label>
          <input class="tags-input" id="tags" name="tags" type="text" placeholder="ser/estar, beginner, A2" />
          <div class="help">Comma-separated (e.g., <em>ser/estar, beginner, A2</em>).</div>
        </div>

        <!-- Editor -->
        <div class="field">
          <label class="label">Content</label>
          <div class="toolbar-note">
            Headings H1–H5, paragraphs, lists, links, tables, code, and media embeds are enabled.
            You can paste **iframe** snippets (H5P, YouTube, Canva, Genially, etc.) directly.
          </div>
          <textarea id="editor" name="html"></textarea>
        </div>
      </form>
    </div>

    <div class="actions">
      <button type="button" class="btn secondary" id="cancelBtn"
        style="color:#dc2626;font-weight:400;background:#e2e8f0;"
        onclick="if (confirm('Discard this page and return to Pages?')) window.location.href='{{ url_for('admin.admin_pages_index') }}'">
        Cancel
      </button>
      <button type="button" class="btn secondary" id="resetBtn">Reset</button>
      <button type="button" class="btn primary" id="publishBtn">Publish</button>
    </div>
  </div>
</div>

<script>
  // Initialize TinyMCE (with Accordion support via <details>/<summary>)
  tinymce.init({
    selector: '#editor',
    base_url: 'https://cdn.jsdelivr.net/npm/tinymce@6.8.3',
    suffix: '.min',
    height: 520,
    menubar: 'file edit view insert format tools table',
    plugins: 'code link lists table media image autoresize template visualblocks',
    toolbar: [
      'undo redo | blocks | bold italic underline removeformat |',
      'alignleft aligncenter alignright alignjustify | bullist numlist outdent indent |',
      'link image media table | template visualblocks | code'
    ].join(' '),

    // Block formats
    block_formats: 'Paragraph=p; H1=h1; H2=h2; H3=h3; H4=h4; H5=h5',

    // Allow embeds + details/summary for accordions
    extended_valid_elements: [
      'iframe[src|frameborder|allow|allowfullscreen|width|height|style|loading]',
      'script[src|type]',
      'details[class|open]',
      'summary[class]',
      'div[*]',
      'span[*]',
      'p[*]',
      'h1[*],h2[*],h3[*],h4[*],h5[*]',
      'ul[*],ol[*],li[*]',
      'table[*],thead[*],tbody[*],tr[*],th[*],td[*]',
      'img[src|alt|width|height|style]'
    ].join(','),

    // Let <details> contain useful children
    valid_children: [
      '+details[summary|div|p|ul|ol|table|img|iframe|h1|h2|h3|h4|h5]',
      '+div[iframe|div|span|p|h1|h2|h3|h4|h5|ul|ol|table|img]',
      '+p[iframe|span|strong|em|a|img|code]'
    ].join(','),

    // Editor content styles (so accordions look nice while editing)
    content_style: `
      @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
      body { font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; font-size:16px; color:#0f172a; }
      h1,h2,h3,h4,h5 { font-weight:700; color:#0f172a; margin: 1.1em 0 .5em; }
      p { line-height: 1.7; margin: .6em 0; }
      pre, code { background:#0b102026; padding:.15rem .35rem; border-radius:6px; }
      table { width:100%; border-collapse: collapse; }
      table, th, td { border:1px solid #e2e8f0; }
      th, td { padding:.5rem .6rem; }
      iframe { display:block; max-width:100%; border:0; margin: .75rem 0; }
      img { max-width:100%; height:auto; }
      ul,ol { padding-left: 1.35rem; }
      a { color:#2563eb; text-decoration: underline; }

      /* Accordion styling inside the editor */
      details.pp-accordion { border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin:.75rem 0; }
      details.pp-accordion + details.pp-accordion { margin-top:.5rem; }
      details.pp-accordion > summary {
        cursor:pointer; list-style:none; padding:.6rem .8rem; font-weight:600; color:#0f172a; display:flex; align-items:center; gap:.5rem;
      }
      details.pp-accordion > summary::-webkit-details-marker { display:none; }
      details.pp-accordion > summary::before {
        content:"▸"; transform: translateY(1px);
      }
      details.pp-accordion[open] > summary::before { content:"▾"; }
      .pp-accordion-body { padding:.6rem .8rem .8rem; border-top:1px solid #e5e7eb; color:#334155; }
    `,

    // Keep iframes on paste
    paste_remove_elements: '',
    paste_data_images: true,
    convert_urls: false,

    // One-click “Accordion” template
    templates: [
      {
        title: 'Accordion',
        description: 'Insert a collapsible section (details/summary)',
        content: `
<details class="pp-accordion" open>
  <summary>Section title</summary>
  <div class="pp-accordion-body">
    <p>Write your content here…</p>
  </div>
</details>`
      },
      {
        title: 'FAQ Accordion (2 items)',
        description: 'Two collapsible questions',
        content: `
<details class="pp-accordion" open>
  <summary>Question 1</summary>
  <div class="pp-accordion-body">
    <p>Answer 1…</p>
  </div>
</details>
<details class="pp-accordion" open>
  <summary>Question 2</summary>
  <div class="pp-accordion-body">
    <p>Answer 2…</p>
  </div>
</details>`
      }
    ]
  });

  // Helpers
  const $ = sel => document.querySelector(sel);
  const showSaved = () => {
    const pill = $('#saveOk');
    pill.classList.add('show');
    setTimeout(() => pill.classList.remove('show'), 2200);
  };
  const getSlugParam = () => new URLSearchParams(location.search).get('slug');

  // Prefill when editing (?slug=...)
  (function prefillIfEditing(){
    const slug = getSlugParam();
    if (!slug) return;

    // Update header + primary button text
    const h = document.querySelector('.pages-head h1');
    if (h) h.textContent = 'Edit Page';
    const pub = $('#publishBtn');
    if (pub) pub.textContent = 'Update';

    // Helper: wait until TinyMCE editor is fully initialized
    const waitForEditor = () => new Promise((resolve) => {
      const tick = () => {
        const ed = tinymce.get('editor');
        if (ed && ed.initialized) return resolve(ed);
        setTimeout(tick, 50);
      };
      tick();
    });

    (async () => {
      try {
        const res = await fetch(`/admin/pages/${slug}.json`);
        if (!res.ok) return;
        const data = await res.json();
        if (!data || !data.page) return;

        const p = data.page;
        $('#title').value = p.title || '';
        $('#tags').value = Array.isArray(p.tags) ? p.tags.join(', ') : (p.tags || '');

        const ed = await waitForEditor();
        ed.setContent(p.html || '');
      } catch (e) {
        console.error(e);
      }
    })();
  })();

  // Reset form
  $('#resetBtn').addEventListener('click', () => {
    $('#pageForm').reset();
    if (tinymce.get('editor')) tinymce.get('editor').setContent('');
  });

  // Publish / Update
  $('#publishBtn').addEventListener('click', async () => {
    const title = $('#title').value.trim();
    const tags = $('#tags').value.trim();
    const html = tinymce.get('editor') ? tinymce.get('editor').getContent() : '';
    const slug = getSlugParam();

    if (!title || !html) {
      alert("Please add both a Title and Content.");
      return;
    }

    const form = new FormData();
    form.append('title', title);
    form.append('tags', tags);
    form.append('html', html);

    // Create vs Update endpoint
    const endpoint = slug ? `/admin/pages/${slug}/update` : '/admin/pages';

    try {
      const res = await fetch(endpoint, { method: 'POST', body: form });
      const data = await res.json();
      if (!data.success) {
        console.error(data);
        alert(data.error || 'Failed to save page.');
        return;
      }
      showSaved();
    } catch (e) {
      console.error(e);
      alert('Network error while saving page.');
    }
  });
</script>
{% endblock %}