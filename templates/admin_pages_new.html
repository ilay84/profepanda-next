{% extends "base.html" %}
{% block title %}Admin · New Page{% endblock %}

{% block admin_nav %}
  {% include "_admin_bar.html" %}
{% endblock %}

{% block content %}
<style>
  /* Use Montserrat for this page (base.css may already do this, but enforce here) */
  @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
  .pages-wrapper { font-family: 'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
  .pages-card {
    max-width: 980px; margin: 1.5rem auto; background: #fff; border: 1px solid #e5e7eb;
    border-radius: 14px; box-shadow: 0 6px 18px rgba(0,0,0,.06);
  }
  .pages-head {
    padding: 1rem 1.25rem; border-bottom: 1px solid #eef2f7; display:flex; align-items:center; justify-content:space-between;
  }
  .pages-head h1 { font-size: 1.25rem; margin: 0; font-weight: 700; color: #0f172a; }
  .pages-body { padding: 1.25rem; }
  .field { margin-bottom: 1rem; }
  .label { display:block; font-weight:600; margin-bottom:.4rem; color:#334155; }
  .input, .tags-input {
    width:100%; padding:.625rem .75rem; border:1px solid #cbd5e1; border-radius:10px; font-size:1rem; outline:none;
  }
  .input:focus, .tags-input:focus { border-color:#2563eb; box-shadow:0 0 0 3px rgba(37,99,235,.15); }
  .help { color:#64748b; font-size:.9rem; margin-top:.25rem; }
  .toolbar-note{ color:#475569; font-size:.9rem; margin:.25rem 0 1rem; }
  .actions { display:flex; gap:.6rem; justify-content:flex-end; border-top:1px solid #eef2f7; padding:1rem 1.25rem; }
  .btn {
    appearance:none; border:0; padding:.65rem 1rem; border-radius:10px; font-weight:600; cursor:pointer;
  }
  .btn.primary { background:#2563eb; color:#fff; }
  .btn.secondary { background:#e2e8f0; color:#0f172a; }
  .success-pill {
    display:none; margin-left:auto; margin-right:.5rem; align-items:center; gap:.4rem;
    padding:.35rem .6rem; border-radius:999px; background:#dcfce7; color:#166534; font-weight:600; font-size:.9rem;
  }
  .success-pill.show{ display:inline-flex; }

  /* Visually pin the saved pill near the bottom-right actions so it's seen next to Publish */
  #saveOk.success-pill.show {
    position: fixed;
    right: 24px;
    bottom: 24px;
    z-index: 50;
    box-shadow: 0 8px 22px rgba(0,0,0,.12);
  }

  /* Saving spinner next to Publish */
  .saving { display:none; align-items:center; gap:.5rem; font-weight:600; color:#475569; }
  .saving.show { display:inline-flex; }
  .saving .dot {
    display:inline-block; width:10px; height:10px; border-radius:50%;
    border:2px solid currentColor; border-top-color: transparent;
    animation: spin .8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
</style>

<!-- Editors & converters -->
<script src="https://cdn.jsdelivr.net/npm/tinymce@6.8.3/tinymce.min.js" referrerpolicy="origin"></script>
<script src="https://cdn.jsdelivr.net/npm/turndown@7.2.0/dist/turndown.min.js" referrerpolicy="origin"></script>

<div class="pages-wrapper">
  <div class="pages-card">
    <div class="pages-head" id="pagesHead" data-slug="{{ page.slug if page and page.slug }}">
      <h1>New Page</h1>
      <span id="saveOk" class="success-pill">✓ Saved</span>
    </div>

    <div class="pages-body">
      <form id="pageForm">
        {# Ensure 'page' exists on new-page view #}
        {% if page is not defined %}{% set page = {} %}{% endif %}

        <!-- Title -->
        <div class="field">
          <label class="label" for="title">Title</label>
          <input class="input" id="title" name="title" type="text" placeholder="Enter the page title" />
        </div>

        <!-- Bilingual content (Option B) -->
        <div class="field">
          <h3 style="font-weight:600; margin:12px 0 6px;">English version</h3>

          <label class="label" for="title_en">Title (English)</label>
          <input class="input" id="title_en" name="title_en" type="text" placeholder="Enter the English title" value="{{ (page.title_en or (page.title if (page.title and not page.title_es))) or '' }}" />

          <label class="label" for="tags_en" style="margin-top:10px;">Tags (English, comma-separated)</label>
          <input class="input" id="tags_en" name="tags_en" type="text" placeholder="e.g., verbs, copulas, A2" value="{{ (page.tags_en or (page.tags if (page.tags and not page.tags_es)) or [])|join(', ') }}" />

          <label class="label" for="html_en" style="margin-top:10px;">Content (English)</label>
          <textarea class="input" id="html_en" name="html_en" rows="12" placeholder="Enter the English HTML or rich text">{{ (page.html_en or (page.html if (page.html and not page.html_es)) or '') }}</textarea>
          <div class="help">Fill in any of these fields. If you leave all of them empty, only the Spanish version will be shown.</div>
        </div>

        <div class="field" style="margin-top:18px;">
          <h3 style="font-weight:600; margin:12px 0 6px;">Versión en español</h3>

          <label class="label" for="title_es">Título (Español)</label>
          <input class="input" id="title_es" name="title_es" type="text" placeholder="Ingresá el título en español" value="{{ page.title_es or (page.title if (page.title and not page.title_en)) or '' }}" />

          <label class="label" for="tags_es" style="margin-top:10px;">Etiquetas (Español, separadas por coma)</label>
          <input class="input" id="tags_es" name="tags_es" type="text" placeholder="p. ej., verbos, ser y estar, A2" value="{{ (page.tags_es or (page.tags if (page.tags and not page.tags_en)) or [])|join(', ') }}" />

          <label class="label" for="html_es" style="margin-top:10px;">Contenido (Español)</label>
          <textarea class="input" id="html_es" name="html_es" rows="12" placeholder="Ingresá el HTML o texto enriquecido en español">{{ page.html_es or (page.html if (page.html and not page.html_en)) or '' }}</textarea>
          <div class="help">Completá los campos que necesites. Si dejás todo vacío en español, solo se mostrará la versión en inglés.</div>
        </div>
      </form>
    </div>

<div class="actions">
      <button type="button" class="btn secondary" id="cancelBtn"
        style="color:#dc2626;font-weight:400;background:#e2e8f0;"
        onclick="if (confirm('Discard this page and return to Pages?')) { window.location.href='{{ url_for('admin.admin_pages_index') }}'; }">
        Cancel
      </button>

      <button type="button" class="btn secondary" id="resetBtn">Reset</button>

      <!-- New: Copy all content as Markdown -->
      <button type="button" class="btn secondary" id="copyMdBtn" title="Copy all content as Markdown">
        Copy as Markdown
      </button>

      <!-- Saving indicator (shown while publishing) -->
      <span id="savingIndicator" class="saving" aria-live="polite" style="margin-left:auto;">
        <span class="dot"></span> Saving…
      </span>

      <button type="button" class="btn primary" id="publishBtn">Publish</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    // ---- Safe helpers ----
    const $ = (sel) => document.querySelector(sel);

    // Ensure "Copy as Markdown" button exists (inject if missing)
    (function ensureCopyBtn(){
      var actions = document.querySelector('.actions');
      if (!actions) return;
      var existing = document.getElementById('copyMdBtn');
      if (existing) return;
      var btn = document.createElement('button');
      btn.type = 'button';
      btn.id = 'copyMdBtn';
      btn.className = 'btn secondary';
      btn.title = 'Copy all content as Markdown';
      btn.textContent = 'Copy as Markdown';
      // Insert after Reset if present; otherwise append at start
      var reset = document.getElementById('resetBtn');
      if (reset && reset.parentNode === actions) {
        actions.insertBefore(btn, reset.nextSibling);
      } else {
        actions.insertBefore(btn, actions.firstChild);
      }
    })();

    // Slug detection (reads data attribute first, then URL patterns)
    const getSlugParam = () => {
      try {
        // 0) ?slug=... (used by /admin/pages/<slug>/edit → redirect)
        const usp = new URLSearchParams(window.location.search);
        const qs = usp.get('slug');
        if (qs) return decodeURIComponent(qs);

        // 1) data attribute (if template was rendered with a page)
        const headEl = document.getElementById('pagesHead');
        const ds = headEl && headEl.dataset ? headEl.dataset.slug : '';
        if (ds) return ds;

        // 2) /admin/pages/<slug>/edit
        let path = window.location.pathname || '';
        let m = path.match(/\/admin\/pages\/([^\/]+)\/edit\/?$/);
        if (m && m[1]) return decodeURIComponent(m[1]);

        // 3) /admin/pages/<slug>
        m = path.match(/\/admin\/pages\/([^\/]+)\/?$/);
        if (m && m[1] && m[1] !== 'new') return decodeURIComponent(m[1]);

        // 4) <meta name="pp-page-slug" ...>
        const meta = document.querySelector('meta[name="pp-page-slug"]');
        if (meta && meta.content) return meta.content;
      } catch (e) { console.error('Slug detection failed:', e); }
      return null;
    };

    const showSaved = () => {
      const pill = $('#saveOk');
      if (pill) {
        pill.textContent = '✓ Guardado exitosamente';
        // Move pill to top-right instead of bottom-right
        Object.assign(pill.style, {
          position: 'fixed',
          top: '24px',
          right: '24px',
          bottom: 'auto',
          zIndex: '100',
          boxShadow: '0 6px 16px rgba(0,0,0,.12)'
        });
        pill.classList.add('show');
        setTimeout(() => pill.classList.remove('show'), 1800);
      }

      // Hide spinner & re-enable Publish
      const saving = $('#savingIndicator');
      const pubBtn = $('#publishBtn');
      if (saving) saving.classList.remove('show');
      if (pubBtn) pubBtn.disabled = false;

      // Scroll user to top smoothly
      window.scrollTo({ top: 0, behavior: 'smooth' });
    };

    // ---- Init TinyMCE (both editors) ----
    try {
      tinymce.init({
        selector: '#html_en,#html_es',
        base_url: 'https://cdn.jsdelivr.net/npm/tinymce@6.8.3',
        suffix: '.min',
        height: 520,
        menubar: 'file edit view insert format tools table',
        plugins: 'code link lists table media image autoresize template visualblocks template',
        toolbar: [
          'undo redo | blocks | bold italic underline forecolor backcolor removeformat |',
          'alignleft aligncenter alignright alignjustify | bullist numlist outdent indent |',
          'link image media table | template visualblocks | code'
        ].join(' '),
        block_formats: 'Paragraph=p; H1=h1; H2=h2; H3=h3; H4=h4; H5=h5',
        extended_valid_elements: [
          'iframe[src|frameborder|allow|allowfullscreen|width|height|style|loading]',
          'script[src|type]',
          'details[class|open]',
          'summary[class]',
          'div[*]',
          'span[*]',
          'p[*]',
          'h1[*],h2[*],h3[*],h4[*],h5[*]',
          'ul[*],ol[*],li[*]',
          'table[*],thead[*],tbody[*],tr[*],th[*],td[*]',
          'img[src|alt|width|height|style]'
        ].join(','),
        templates: [{
          title: 'Accordion',
          description: 'Collapsible section',
          content: `
<details class="pp-accordion" open>
  <summary><strong>Section title</strong></summary>
  <div class="pp-accordion-body">
    <p>Write your content here…</p>
  </div>
</details>`
        }],
        paste_remove_elements: '',
        paste_data_images: true,
        convert_urls: false,
        content_style: `
          @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap');
          body { font-family:'Montserrat', system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; color:#0f172a; line-height:1.8; }
          img { max-width:100%; height:auto; }
          iframe { max-width:100%; width:100%; border:0; margin:.75rem 0; }
          details.pp-accordion { border:1px solid #e5e7eb; border-radius:10px; background:#fff; margin:.75rem 0; }
          details.pp-accordion + details.pp-accordion { margin-top:.5rem; }
          details.pp-accordion > summary { cursor:pointer; list-style:none; padding:.6rem .8rem; font-weight:600; color:#0f172a; display:flex; align-items:center; gap:.5rem; }
          details.pp-accordion > summary::-webkit-details-marker { display:none; }
          details.pp-accordion > summary::before { content:"▸"; transform: translateY(1px); }
          details.pp-accordion[open] > summary::before { content:"▾"; }
          .pp-accordion-body { padding:.6rem .8rem .8rem; border-top:1px solid #e5e7eb; color:#334155; }
        `
      });
    } catch (e) {
      console.error('TinyMCE init failed:', e);
    }

    // ---- Reset button ----
    const resetBtn = $('#resetBtn');
    if (resetBtn) {
      resetBtn.addEventListener('click', () => {
        const form = $('#pageForm');
        if (form) form.reset();
        if (tinymce.get('html_en')) tinymce.get('html_en').setContent('');
        if (tinymce.get('html_es')) tinymce.get('html_es').setContent('');
      });
    }

    // ---- Prefill when editing ----
    (async function prefillIfEditing() {
      const slug = getSlugParam();
      if (!slug) return; // "new" mode

      try {
        const res = await fetch(`/admin/pages/${encodeURIComponent(slug)}/json`, { method: 'GET' });
        const data = await res.json();
        if (!data.success || !data.page) return;
        const p = data.page;

        const title_en = p.title_en || (p.title && !p.title_es ? p.title : '');
        const title_es = p.title_es || (p.title && !p.title_en ? p.title : '');
        const tags_en  = Array.isArray(p.tags_en) ? p.tags_en : (!p.tags_es && Array.isArray(p.tags) ? p.tags : []);
        const tags_es  = Array.isArray(p.tags_es) ? p.tags_es : (!p.tags_en && Array.isArray(p.tags) ? p.tags : []);
        const html_en  = p.html_en || (p.html && !p.html_es ? p.html : '');
        const html_es  = p.html_es || (p.html && !p.html_en ? p.html : '');

        const tMain = $('#title');
        const tEn = $('#title_en'), tEs = $('#title_es');
        const gEn = $('#tags_en'),  gEs = $('#tags_es');

        // Main (legacy) title shows whatever currently represents the page title.
        if (tMain) tMain.value = (p.title || title_en || title_es || '');

        if (tEn) tEn.value = title_en || '';
        if (tEs) tEs.value = title_es || '';
        if (gEn) gEn.value = (tags_en || []).join(', ');
        if (gEs) gEs.value = (tags_es || []).join(', ');

        const setEditorWhenReady = (id, html) => {
          const trySet = () => {
            const ed = tinymce.get(id);
            if (ed) { ed.setContent(html || ''); return true; }
            return false;
          };
          if (!trySet()) {
            const iv = setInterval(() => { if (trySet()) clearInterval(iv); }, 60);
            setTimeout(() => clearInterval(iv), 4000);
          }
        };
        setEditorWhenReady('html_en', html_en);
        setEditorWhenReady('html_es', html_es);
      } catch (e) {
        console.error('Prefill failed:', e);
      }
    })();

    // ---- Publish / Update ----
    const publishBtn = $('#publishBtn');
    if (publishBtn) {
      publishBtn.addEventListener('click', async () => {
        const saving = document.getElementById('savingIndicator');
        if (saving) saving.classList.add('show');
        publishBtn.disabled = true;
        try {
          // Read fields
          const title_main = ($('#title')?.value     || '').trim();   // <-- main title
          const title_en   = ($('#title_en')?.value  || '').trim();
          const tags_en    = ($('#tags_en')?.value   || '').trim();
          const title_es   = ($('#title_es')?.value  || '').trim();
          const tags_es    = ($('#tags_es')?.value   || '').trim();

          const html_en = tinymce.get('html_en') ? tinymce.get('html_en').getContent() : ($('#html_en')?.value || '');
          const html_es = tinymce.get('html_es') ? tinymce.get('html_es').getContent() : ($('#html_es')?.value || '');

          if (!(title_en || html_en || title_es || html_es || title_main)) {
            alert('Please fill at least one language (English or Spanish).');
            return;
          }

          // 🧩 Legacy fields for compatibility (do NOT cross-fill EN/ES)
          const legacy_title = title_main || title_es || title_en || '';
          const legacy_html  = '';   // DO NOT use EN/ES here — prevents cross-fill into either language
          const legacy_tags  = '';   // Keep legacy tags empty so they don’t overwrite bilingual tags

          const form = new FormData();
          // Preserve exactly what the user typed (allow empty strings)
          const submit_html_en = html_en;
          const submit_html_es = html_es;

          form.append('title_en', title_en);
          form.append('html_en',  submit_html_en);
          form.append('tags_en',  tags_en);
          form.append('title_es', title_es);
          form.append('html_es',  submit_html_es);
          form.append('tags_es',  tags_es);
          // Legacy mirrors (keep older renderers & slug creation happy)
          form.append('title', legacy_title);
          form.append('html',  legacy_html);
          form.append('tags',  legacy_tags);

          const slug = getSlugParam();
          const creating = !slug;
          const endpoint = creating ? '/admin/pages' : `/admin/pages/${encodeURIComponent(slug)}/update`;

          const res = await fetch(endpoint, { method: 'POST', body: form });
          const data = await res.json();
          if (!data.success) {
            console.error(data);
            alert(data.error || 'Failed to save page.');
            return;
          }

          if (creating && data.page && data.page.slug) {
            // Jump to edit so subsequent saves UPDATE (not create new)
            window.location.href = `/admin/pages/${encodeURIComponent(data.page.slug)}/edit`;
            return;
          }
          showSaved();
        } catch (e) {
          console.error('Save failed:', e);
          alert('Network error while saving page.');
        }
      });
    }

    // ---- Copy as Markdown (per-language: EN / ES; Actions bar only) ----
    (function () {
      // 1) Ensure two buttons in the Actions bar (after Reset)
      function ensureBarButton(id, text, title) {
        var actions = document.querySelector('.actions');
        if (!actions) return null;
        var existing = document.getElementById(id);
        if (existing) return existing;

        var btn = document.createElement('button');
        btn.type = 'button';
        btn.id = id;
        btn.className = 'btn secondary';
        btn.textContent = text;
        btn.title = title;

        var reset = document.getElementById('resetBtn');
        if (reset && reset.parentNode === actions) {
          actions.insertBefore(btn, reset.nextSibling);
        } else {
          actions.insertBefore(btn, actions.firstChild);
        }
        return btn;
      }

      var btnEn = ensureBarButton('copyMdBtnEn', 'Copy Markdown (EN)', 'Copy English editor as Markdown');
      var btnEs = ensureBarButton('copyMdBtnEs', 'Copiar Markdown (ES)', 'Copiar el editor en español a Markdown');

      // 2) Helpers to read editor HTML
      function getEditorHTMLById(id) {
        if (window.tinymce && tinymce.get && tinymce.get(id)) {
          try { return tinymce.get(id).getContent({ format: 'html' }) || ''; }
          catch (e) { return tinymce.get(id).getContent() || ''; }
        }
        var ta = document.getElementById(id);
        return (ta && ta.value) ? ta.value : '';
      }

      // 3) Fallback HTML→MD (basic) if Turndown isn’t available
      function naiveHtmlToMd(html) {
        if (!html) return '';
        var md = html;
        md = md.replace(/<\/h1>/gi, '\n').replace(/<h1[^>]*>/gi, '# ');
        md = md.replace(/<\/h2>/gi, '\n').replace(/<h2[^>]*>/gi, '## ');
        md = md.replace(/<\/h3>/gi, '\n').replace(/<h3[^>]*>/gi, '### ');
        md = md.replace(/<\/h4>/gi, '\n').replace(/<h4[^>]*>/gi, '#### ');
        md = md.replace(/<\/p>/gi, '\n\n').replace(/<p[^>]*>/gi, '');
        md = md.replace(/<br\s*\/?>/gi, '\n');
        md = md.replace(/<li[^>]*>/gi, '- ').replace(/<\/li>/gi, '\n');
        md = md.replace(/<\/ul>/gi, '\n').replace(/<ul[^>]*>/gi, '\n');
        md = md.replace(/<\/ol>/gi, '\n').replace(/<ol[^>]*>/gi, '\n');
        md = md.replace(/<strong[^>]*>|<b[^>]*>/gi, '**').replace(/<\/strong>|<\/b>/gi, '**');
        md = md.replace(/<em[^>]*>|<i[^>]*>/gi, '*').replace(/<\/em>|<\/i>/gi, '*');
        md = md.replace(/<u[^>]*>|<\/u>/gi, '');
        md = md.replace(/<img[^>]*alt="([^"]*)"[^>]*src="([^"]+)"[^>]*>/gi, '![$1]($2)');
        md = md.replace(/<a[^>]*href="([^"]+)"[^>]*>(.*?)<\/a>/gi, '[$2]($1)');
        md = md.replace(/<\/?[^>]+>/g, '');
        md = md.replace(/\n{3,}/g, '\n\n').trim();
        return md;
      }

      // 4) Core copy routine for a single editor
      function copyOneEditorAsMarkdown(editorId, triggerBtn) {
        var html = getEditorHTMLById(editorId);
        if (!html || !html.trim()) {
          alert('No content to copy in this editor.');
          return;
        }

        var useTurndown = (typeof window.TurndownService === 'function');
        var turndown = useTurndown ? new TurndownService({
          headingStyle: 'atx',
          codeBlockStyle: 'fenced',
          bulletListMarker: '-',
          emDelimiter: '*',
          hr: '---'
        }) : null;

        if (turndown) {
          turndown.addRule('details', {
            filter: function (node) { return node.nodeName === 'DETAILS'; },
            replacement: function (content, node) {
              var summary = node.querySelector && node.querySelector('summary');
              var title = summary ? '**' + summary.textContent.trim() + '**' : '**Details**';
              return title + '\n\n' + (content || '').trim() + '\n';
            }
          });
        }

        var md = useTurndown ? turndown.turndown(html) : naiveHtmlToMd(html);

        var done = function () {
          var original = triggerBtn.textContent;
          triggerBtn.textContent = 'Copied!';
          triggerBtn.disabled = true;
          setTimeout(function () { triggerBtn.textContent = original; triggerBtn.disabled = false; }, 1200);
        };

        if (navigator.clipboard && navigator.clipboard.writeText) {
          navigator.clipboard.writeText(md).then(done).catch(function () {
            var ta = document.createElement('textarea');
            ta.value = md; document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); } finally { document.body.removeChild(ta); done(); }
          });
        } else {
          var ta = document.createElement('textarea');
          ta.value = md; document.body.appendChild(ta); ta.select();
          try { document.execCommand('copy'); } finally { document.body.removeChild(ta); done(); }
        }
      }

      // 5) Wire the Actions-bar buttons
      function wire(id, editorId) {
        var btn = document.getElementById(id);
        if (btn && !btn.__ppMdWired) {
          btn.__ppMdWired = true;
          btn.addEventListener('click', function () { copyOneEditorAsMarkdown(editorId, btn); });
        }
      }
      wire('copyMdBtnEn', 'html_en');
      wire('copyMdBtnEs', 'html_es');
    })();
  });
</script>
{% endblock %}