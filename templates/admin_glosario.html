{% extends "base.html" %}

{% block title %}Admin – Glosario {{ country_code|upper }}{% endblock %}

{% block admin_nav %}
  {% include "_admin_bar.html" %}
{% endblock %}

{% block content %}
<h2 style="margin:1rem auto;max-width:1100px">Glosario — {{ country_code|upper }}</h2>

<div class="admin-toolbar" style="max-width:1100px;margin:.25rem auto 1rem;display:flex;gap:.5rem;align-items:center;">
  <a href="{{ url_for('admin.admin_home') }}" style="text-decoration:none;border:1px solid #e5e7eb;border-radius:10px;padding:.5rem .75rem;background:#fff;display:inline-block;">⬅ Volver</a>
  <button id="btnNewEntry" type="button" style="appearance:none;border:1px solid #cfe3fb;border-radius:10px;padding:.5rem .75rem;background:#f7fbff;color:#1e40af;font-weight:700;cursor:default;" disabled>➕ Nueva entrada</button>
  <span style="color:#64748b;">(el editor lo conectamos en el siguiente paso)</span>
</div>

<p style="max-width:1100px;margin:.25rem auto 1rem;color:#64748b;">
  Total: {{ entries|length }} entradas
</p>

<div class="admin-glossary-grid">
  {% for e in entries %}
    <div class="admin-entry-card" title="Entrada del glosario" data-entry='{{ e|tojson|safe }}'>
      <div class="left">
        <div class="admin-entry-word">{{ e.word }}</div>
        <div class="meta">
          <span class="badge">{{ (e.senses or [])|length }} acep.</span>
          <span class="badge">{{ (e.variants or {})|length }} variantes</span>
        </div>
      </div>
      <div class="right">
        <button type="button"
                class="admin-edit-btn"
                title="Editar"
                onclick='editEntry({{ e.word|tojson }}, {{ e|tojson|safe }})'>
          ✎
        </button>
      </div>
    </div>
  {% endfor %}
</div>
{% endblock %}

{% block scripts %}
<style>
/* Grid of entry cards */
.admin-glossary-grid{
  max-width:1100px;
  margin:0 auto 2rem;
  display:grid;
  gap: .75rem;
  grid-template-columns: repeat(2, minmax(0,1fr));
}
@media (min-width: 900px){ .admin-glossary-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
@media (min-width: 1280px){ .admin-glossary-grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } }

/* Card */
.admin-entry-card{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  box-shadow:0 1px 4px rgba(0,0,0,.06);
  padding:.7rem .8rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
}
.admin-entry-card .left{min-width:0;}
.admin-entry-word{
  font-weight:800;
  color:#0f172a;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.meta{display:flex;gap:.35rem;margin-top:.2rem; color:#64748b; font-size:.85rem;}
.badge{border:1px solid #cbd5e1;border-radius:999px;padding:.05rem .5rem;background:#f8fafc;}

.admin-edit-btn{
  border:1px solid #d7e3f3; background:#f6fbff; border-radius:8px;
  padding:.35rem .55rem; cursor:pointer; color:#1e40af; font-weight:700;
}

</style>

<!-- Quill (form needs it even to render); saving wire-up is next step -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">

<style>
  /* Keep our rules after Quill's so they win */
  #formModal .ql-container{
    height:auto !important;
    max-height:300px;         /* fallback cap on the container */
    overflow-y:auto;
  }
  #formModal .ql-editor{
    min-height:140px;         /* comfy start size */
    max-height:260px;         /* cap the editor itself */
    overflow-y:auto;
  }
  /* keep toolbar visible while the editor scrolls */
  #formModal .ql-toolbar.ql-snow{ position: sticky; top:0; z-index:1; }
</style>

<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
/* ---------- Modal bootstrap ---------- */
function ensureModal() {
  let m = document.getElementById('formModal');
  if (m) return m;

  const css = `
    #formModal{position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);display:none;}
    #formModal .modal-content{background:#fff;margin:5vh auto;max-width:960px;border-radius:12px;overflow:hidden;box-shadow:0 18px 50px rgba(0,0,0,.25);}
    #formModal .modal-header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid #e5e7eb;}
    #formModal .modal-body{padding:1rem;max-height:70vh;overflow:auto;}
    #formModal .close{appearance:none;border:0;background:#f1f5f9;border-radius:8px;padding:.3rem .55rem;font-weight:700;cursor:pointer;}
  `;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);

  m = document.createElement('div');
  m.id = 'formModal';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle" style="margin:0;font-weight:800;">Editar entrada</h3>
        <button class="close" type="button" onclick="closeFormModal()">×</button>
      </div>
      <div class="modal-body"><div style="color:#64748b">Cargando editor…</div></div>
    </div>
  `;
  document.body.appendChild(m);
  return m;
}
function openFormWithHTML(html, title) {
  const m = ensureModal();
  m.querySelector('#modalTitle').textContent = title || 'Editar entrada';
  m.querySelector('.modal-body').innerHTML = html;
  m.style.display = 'block';
}
function closeFormModal() {
  const m = document.getElementById('formModal');
  if (m) m.style.display = 'none';
}

/* ---------- Quill init (for all sense definition editors) ---------- */
function initQuillEditors(root = document){
  root.querySelectorAll('[id^="editor_definicion_"]').forEach(div => {
    const n = div.id.replace('editor_definicion_', '');
    const hidden = (root.getElementById ? root.getElementById('definicion_' + n)
                                        : document.getElementById('definicion_' + n));
    if (div.__quill) return; // already initialized
    const q = new Quill('#' + div.id, {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold','italic','underline','strike'],
          [{ list:'ordered' }, { list:'bullet' }],
          [{ color:[] }, { background:[] }],
          ['link','clean']
        ]
      }
    });
    div.__quill = q;
    if (hidden) q.on('text-change', () => { hidden.value = q.root.innerHTML; });
  });
}

/* ---------- Examples: builder + behaviors (add/remove/toggle source) ---------- */
function buildExampleRow(n){
  const div = document.createElement('div');
  div.className = 'example-item';
  div.innerHTML = `
    <label>Oración (ES)</label>
    <textarea name="example_sentence_${n}[]" rows="2"></textarea>

    <label>Traducción (EN)</label>
    <textarea name="example_translation_${n}[]" rows="2"></textarea>

    <label>Audio del ejemplo</label>
    <input type="file" name="example_audio_${n}[]" accept="audio/*">

    <label>Fuente</label>
    <select name="example_source_kind_${n}[]" class="source-kind">
      <option value="">-- Seleccionar --</option>
      <option value="pelicula">Película</option>
      <option value="serie">Serie</option>
      <option value="redes">Redes sociales</option>
      <option value="cancion">Canción</option>
      <option value="otro">Otro</option>
    </select>

    <div class="source-fields source-pelicula" style="display:none;">
      <label>Título</label>
      <input type="text" name="example_source_title_${n}[]">
      <label>Año</label>
      <input type="text" name="example_source_year_${n}[]">
    </div>

    <div class="source-fields source-serie" style="display:none;">
      <label>Título</label>
      <input type="text" name="example_source_title_${n}[]">
      <label>Año</label>
      <input type="text" name="example_source_year_${n}[]">
      <label>Temporada</label>
      <input type="text" name="example_source_season_${n}[]">
      <label>Episodio</label>
      <input type="text" name="example_source_episode_${n}[]">
    </div>

    <div class="source-fields source-redes" style="display:none;">
      <label>Usuario/Handle</label>
      <input type="text" name="example_source_handle_${n}[]">
      <label>URL</label>
      <input type="text" name="example_source_url_${n}[]">
    </div>

    <div class="source-fields source-cancion" style="display:none;">
      <label>Canción</label>
      <input type="text" name="example_source_song_${n}[]">
      <label>Artista</label>
      <input type="text" name="example_source_artist_${n}[]">
    </div>

    <div class="source-fields source-otro" style="display:none;">
      <label>Fuente</label>
      <input type="text" name="example_source_text_${n}[]">
    </div>

    <button type="button" class="remove-example">Eliminar ejemplo</button>
  `;
  return div;
}

function attachExampleBehaviors(root = document){
  if (window.__ppExamplesWired) return;           // avoid multiple listeners on re-open
  window.__ppExamplesWired = true;

  // Add example
  root.addEventListener('click', e=>{
    const btn = e.target.closest('.add-example');
    if (!btn) return;
    const block = btn.closest('.sentido-block');
    const n = block?.dataset?.sentido;
    const container = block?.querySelector('.examples-container');
    if (!n || !container) return;
    container.appendChild(buildExampleRow(n));
  });

  // Remove example
  root.addEventListener('click', e=>{
    const btn = e.target.closest('.remove-example');
    if (!btn) return;
    const item = btn.closest('.example-item');
    if (item) item.remove();
  });

  // Toggle source-fields groups by kind
  root.addEventListener('change', e=>{
    const sel = e.target.closest('select[name^="example_source_kind_"]');
    if (!sel) return;
    const ex = sel.closest('.example-item');
    if (!ex) return;
    ex.querySelectorAll('.source-fields').forEach(x => x.style.display = 'none');
    const map = { pelicula:'.source-pelicula', serie:'.source-serie', redes:'.source-redes', cancion:'.source-cancion', otro:'.source-otro' };
    const show = ex.querySelector(map[sel.value]);
    if (show) show.style.display = '';
  });
}

/* ---------- Prefill from entry (senses + examples) ---------- */
function prefillFromEntry(entry) {
  const form = document.getElementById('addEntryForm');
  if (!form) { console.warn('addEntryForm not found'); return; }

  const setVal = (sel, val, root=form) => {
    const el = root.querySelector(sel);
    if (el) el.value = val ?? '';
  };

  // Top-level
  setVal('[name="word"]', entry.word || '');
  const v = entry.variants || {};
  setVal('[name="variant_ms"]',          (v.ms || []).join(', '));
  setVal('[name="variant_mp"]',          (v.mp || []).join(', '));
  setVal('[name="variant_fs"]',          (v.fs || []).join(', '));
  setVal('[name="variant_fp"]',          (v.fp || []).join(', '));
  setVal('[name="variant_diminutivo"]',  (v.diminutivo || []).join(', '));
  setVal('[name="variant_aumentativo"]', (v.aumentativo || []).join(', '));

  // Senses
  const senses = Array.isArray(entry.senses) ? entry.senses : [];
  const targetCount = Math.max(1, senses.length);

  // Try to grow sense blocks via the "+" button if present
  const addSenseBtn = document.getElementById('addSentidoBtn');
  const currentBlocks = () => document.querySelectorAll('.sentido-block').length;
  while (addSenseBtn && currentBlocks() < targetCount) addSenseBtn.click();

  senses.forEach((s, i) => {
    const n = i + 1;
    const block = document.querySelector(`.sentido-block[data-sentido="${n}"]`);
    if (!block) return;

    // Definition (hidden + Quill)
    const defHTML = s.definition || '';
    const hiddenDef = block.querySelector(`#definicion_${n}`);
    if (hiddenDef) hiddenDef.value = defHTML;

    const quillDiv = document.getElementById(`editor_definicion_${n}`);
    (function setDefIntoQuill(attempts = 0){
      const q = quillDiv && quillDiv.__quill;
      if (!q) { if (attempts < 40) setTimeout(()=>setDefIntoQuill(attempts+1), 25); return; }
      q.clipboard.dangerouslyPasteHTML(defHTML || '');
      if (hiddenDef) {
        q.off?.('text-change');
        q.on('text-change', () => { hiddenDef.value = q.root.innerHTML; });
      }
    })();

    // Tags / equivalents
    setVal(`#clase_${n}, [name="clase_${n}"]`,                 (s.tag_word_class || []).join(', '), block);
    setVal(`#etiquetas_${n}, [name="etiquetas_${n}"]`,         (s.tag_general || []).join(', '),    block);
    setVal(`#equivalentes_${n}, [name="equivalentes_${n}"]`,   (s.equivalents || []).join(', '),    block);

    // Examples
    const examples = Array.isArray(s.examples) ? s.examples : [];
    const container = block.querySelector('.examples-container');
    if (container) container.innerHTML = '';

    examples.forEach(ex => {
      const exBlock = buildExampleRow(n);
      (container || block).appendChild(exBlock);

      const esField = exBlock.querySelector(`textarea[name="example_sentence_${n}[]"]`);
      const enField = exBlock.querySelector(`textarea[name="example_translation_${n}[]"]`);
      if (esField) esField.value = ex.es || '';
      if (enField) enField.value = ex.en || '';

      const kindSel = exBlock.querySelector(`select[name="example_source_kind_${n}[]"]`);
      const kind = ex?.source?.kind || '';
      if (kindSel) {
        kindSel.value = kind;
        kindSel.dispatchEvent(new Event('change'));
      }

      if (kind === 'pelicula') {
        const wrap = exBlock.querySelector('.source-pelicula');
        wrap?.querySelector(`[name="example_source_title_${n}[]"]`)?.setAttribute('value', ex?.source?.title || '');
        wrap?.querySelector(`[name="example_source_year_${n}[]"]`)?.setAttribute('value',  ex?.source?.year  || '');
      } else if (kind === 'serie') {
        const w = exBlock.querySelector('.source-serie');
        w?.querySelector(`[name="example_source_title_${n}[]"]`)?.setAttribute('value',   ex?.source?.title   || '');
        w?.querySelector(`[name="example_source_year_${n}[]"]`)?.setAttribute('value',    ex?.source?.year    || '');
        w?.querySelector(`[name="example_source_season_${n}[]"]`)?.setAttribute('value',  ex?.source?.season  || '');
        w?.querySelector(`[name="example_source_episode_${n}[]"]`)?.setAttribute('value', ex?.source?.episode || '');
      } else if (kind === 'redes') {
        const w = exBlock.querySelector('.source-redes');
        w?.querySelector(`[name="example_source_handle_${n}[]"]`)?.setAttribute('value', ex?.source?.handle || '');
        w?.querySelector(`[name="example_source_url_${n}[]"]`)?.setAttribute('value',    ex?.source?.url    || '');
      } else if (kind === 'cancion') {
        const w = exBlock.querySelector('.source-cancion');
        w?.querySelector(`[name="example_source_song_${n}[]"]`)?.setAttribute('value',   ex?.source?.song   || '');
        w?.querySelector(`[name="example_source_artist_${n}[]"]`)?.setAttribute('value', ex?.source?.artist || '');
      } else if (kind === 'otro') {
        const w = exBlock.querySelector('.source-otro');
        w?.querySelector(`[name="example_source_text_${n}[]"]`)?.setAttribute('value', ex?.source?.text || '');
      }
    });
  });

  // If there were no senses, ensure the first is blank/ready
  if (senses.length === 0) {
    const block = document.querySelector('.sentido-block[data-sentido="1"]');
    if (block) {
      setVal('#definicion_1, [name="definicion_1"]', '', block);
      const qDiv = block.querySelector('#editor_definicion_1');
      if (qDiv?.__quill) qDiv.__quill.root.innerHTML = '';
    }
  }

  console.debug('Prefilled senses & examples from entry', entry);
}

function wireEditSubmit(originalWord){
  const form = document.getElementById('addEntryForm');
  if (!form) return;

  // avoid double-binding if modal reopens
  if (form.__wiredSubmit) return;
  form.__wiredSubmit = true;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const word = (form.word?.value || '').trim();
    if (!word) { alert('La palabra es requerida'); return; }

    // Variants
    const variants = {
      ms: (form.variant_ms?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      mp: (form.variant_mp?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      fs: (form.variant_fs?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      fp: (form.variant_fp?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      diminutivo: (form.variant_diminutivo?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      aumentativo: (form.variant_aumentativo?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
    };

    // Senses + examples from the DOM
    const senses = [];
    document.querySelectorAll('.sentido-block').forEach((block, idx) => {
      const n = block.dataset.sentido;
      const def = (document.getElementById(`definicion_${n}`)?.value || '').trim();

      const sense = {
        id: `s${idx+1}`,
        tag_word_class: (form[`clase_${n}`]?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        tag_general:    (form[`etiquetas_${n}`]?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        definition: def,
        equivalents:   (form[`equivalentes_${n}`]?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        see_also: [],
        examples: []
      };

      // Examples
      block.querySelectorAll('.example-item').forEach(ex => {
        const es   = ex.querySelector(`textarea[name="example_sentence_${n}[]"]`)?.value.trim() || '';
        const en   = ex.querySelector(`textarea[name="example_translation_${n}[]"]`)?.value.trim() || '';
        const kind = ex.querySelector(`select[name="example_source_kind_${n}[]"]`)?.value || '';

        const source = {};
        if (kind) {
          source.kind = kind;
          if (kind === 'pelicula') {
            source.title = ex.querySelector(`[name="example_source_title_${n}[]"]`)?.value || '';
            source.year  = ex.querySelector(`[name="example_source_year_${n}[]"]`)?.value  || '';
          } else if (kind === 'serie') {
            source.title   = ex.querySelector(`[name="example_source_title_${n}[]"]`)?.value   || '';
            source.year    = ex.querySelector(`[name="example_source_year_${n}[]"]`)?.value    || '';
            source.season  = ex.querySelector(`[name="example_source_season_${n}[]"]`)?.value  || '';
            source.episode = ex.querySelector(`[name="example_source_episode_${n}[]"]`)?.value || '';
          } else if (kind === 'redes') {
            source.handle = ex.querySelector(`[name="example_source_handle_${n}[]"]`)?.value || '';
            source.url    = ex.querySelector(`[name="example_source_url_${n}[]"]`)?.value    || '';
          } else if (kind === 'cancion') {
            source.song   = ex.querySelector(`[name="example_source_song_${n}[]"]`)?.value   || '';
            source.artist = ex.querySelector(`[name="example_source_artist_${n}[]"]`)?.value || '';
          } else if (kind === 'otro') {
            source.text = ex.querySelector(`[name="example_source_text_${n}[]"]`)?.value || '';
          }
        }

        const exObj = { es, en, source };

        // If user selected a new example audio file, predict the saved path (matches server convention)
        const fileInput = ex.querySelector(`input[type="file"][name="example_audio_${n}[]"]`);
        if (fileInput?.files?.length) {
          const orig = fileInput.files[0].name;
          const safe = orig.normalize('NFKD').replace(/[^\w.\-]+/g, '_');
          const serverSlug = word.toLowerCase()
            .replace(/ñ/g,'n')
            .replace(/[^\p{L}\p{N} ]/gu,'-')
            .replace(/ /g,'-');
          exObj.audio = `/static/audio/examples/${serverSlug}/${safe}`;
        }

        if (es || en || Object.keys(source).length) sense.examples.push(exObj);
      });

      if (sense.definition) senses.push(sense);
    });

    if (!senses.length) { alert('Agregá al menos un sentido con definición.'); return; }

    // Build payload
    const fd = new FormData();
    fd.set('original_word', originalWord);
    fd.set('word', word);
    fd.set('variants', JSON.stringify(variants));
    fd.set('senses', JSON.stringify(senses));

    if (form.audio_word?.files?.length) {
      fd.set('audio_word', form.audio_word.files[0]);
    }

    // Attach any example audio files present
    form.querySelectorAll('input[type="file"][name^="example_audio_"]').forEach(inp => {
      [...(inp.files || [])].forEach(f => fd.append(inp.name.replace('[]',''), f));
    });

    try {
      const res = await fetch(`/admin/glosario/{{ country_code }}/update`, { method:'POST', body: fd });
      const data = await res.json();
      if (!res.ok || !data.success) throw new Error(data.error || 'No se pudo actualizar');
      alert('✅ Entrada actualizada');
      location.reload();
    } catch (err) {
      console.error(err);
      alert('❌ Error al actualizar: ' + err.message);
    }
  });
}
</script>
<script>
/* ---------- Open the editor ---------- */
async function editEntry(word, entry) {
  try {
    const resp = await fetch("{{ url_for('static', filename='admin_forms/add_entry_form.html') }}", { cache: "no-store" });
    const html = await resp.text();
    openFormWithHTML(html, `Editar: ${word}`);

    // After the form DOM is in, wire behaviors + init Quill, then prefill + hook submit
    setTimeout(() => {
      attachExampleBehaviors(document);
      initQuillEditors(document);
      prefillFromEntry(entry || { word });
      wireEditSubmit(word);           // ← NEW: make “Guardar” work
    }, 0);

  } catch (e) {
    console.error(e);
    alert("No se pudo cargar el editor.");
  }
}

/* ---------- Optional: open blank form for “Nueva entrada” ---------- */
document.getElementById('btnNewEntry')?.addEventListener('click', async () => {
  try {
    const resp = await fetch("{{ url_for('static', filename='admin_forms/add_entry_form.html') }}", { cache: "no-store" });
    const html = await resp.text();
    openFormWithHTML(html, "Nueva entrada");
    setTimeout(() => {
      attachExampleBehaviors(document);
      initQuillEditors(document);
    }, 0);
  } catch (e) {
    console.error(e);
    alert("No se pudo cargar el editor.");
  }
});
</script>

{% endblock %}