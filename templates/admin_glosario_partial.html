<!-- PARTIAL for /admin/glosario/<country_code>?partial=1 -->
<!-- Renders the cards grid + scripts used for editing within the admin_glosarios.html shell -->

<div class="admin-toolbar" style="max-width:1100px;margin:.25rem auto 1rem;display:flex;gap:.5rem;align-items:center;">
  <button id="btnNewEntry" type="button" style="appearance:none;border:1px solid #cfe3fb;border-radius:10px;padding:.5rem .75rem;background:#f7fbff;color:#1e40af;font-weight:700;cursor:pointer;">‚ûï Nueva entrada</button>
</div>

<p style="max-width:1100px;margin:.25rem auto 1rem;color:#64748b;">
  Total: {{ entries|length }} entradas
</p>

<div class="admin-glossary-grid">
  {% for e in entries %}
    <div class="admin-entry-card"
        title="Entrada del glosario"
        data-entry="{{ e|tojson|forceescape }}">
      <div class="left">
        <div class="admin-entry-word">{{ e.word }}</div>
        <div class="meta">
          <span class="badge">{{ (e.senses or [])|length }} acep.</span>
          <span class="badge">{{ (e.variants or {})|length }} variantes</span>
        </div>
      </div>
      <div class="right" style="display:flex;gap:.35rem;">
        <button type="button"
                class="admin-edit-btn"
                title="Editar"
                onclick='editEntry({{ e.word|tojson }}, {{ e|tojson|safe }})'>
          ‚úé
        </button>
        <button type="button"
                class="admin-del-btn"
                title="Eliminar"
                onclick='deleteEntry(this, {{ e.word|tojson }})'
                style="border:1px solid #fcd6d6;
                       background:#fff5f5;
                       border-radius:8px;
                       padding:.35rem .55rem;
                       cursor:pointer;
                       color:#b91c1c;
                       font-weight:700;">
          üóë
        </button>
      </div>
    </div>
  {% endfor %}
</div>

<style>
/* Grid of entry cards */
.admin-glossary-grid{
  max-width:1100px;
  margin:0 auto 2rem;
  display:grid;
  gap: .75rem;
  grid-template-columns: repeat(2, minmax(0,1fr));
}
@media (min-width: 900px){ .admin-glossary-grid{ grid-template-columns: repeat(3, minmax(0,1fr)); } }
@media (min-width: 1280px){ .admin-glossary-grid{ grid-template-columns: repeat(4, minmax(0,1fr)); } }

/* Card */
.admin-entry-card{
  background:#fff;
  border:1px solid #e5e7eb;
  border-radius:12px;
  box-shadow:0 1px 4px rgba(0,0,0,.06);
  padding:.7rem .8rem;
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:.75rem;
}
.admin-entry-card .left{min-width:0;}
.admin-entry-word{
  font-weight:800;
  color:#0f172a;
  white-space:nowrap; overflow:hidden; text-overflow:ellipsis;
}
.meta{ display:none; }
.badge{border:1px solid #cbd5e1;border-radius:999px;padding:.05rem .5rem;background:#f8fafc;}

.admin-edit-btn{
  border:1px solid #d7e3f3; background:#f6fbff; border-radius:8px;
  padding:.35rem .55rem; cursor:pointer; color:#1e40af; font-weight:700;
}
</style>

<!-- Quill CSS/JS (needed inside the partial for editor modals opened from here) -->
<link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
<script src="https://cdn.quilljs.com/1.3.6/quill.js"></script>

<script>
/* ---------- Modal bootstrap (same helpers as full page) ---------- */
function ensureModal() {
  let m = document.getElementById('formModal');
  if (m) return m;

  const css = `
    #formModal{position:fixed;z-index:1000;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,.45);display:none;}
    #formModal .modal-content{background:#fff;margin:5vh auto;max-width:960px;border-radius:12px;overflow:hidden;box-shadow:0 18px 50px rgba(0,0,0,.25);}
    #formModal .modal-header{display:flex;align-items:center;justify-content:space-between;padding:.8rem 1rem;border-bottom:1px solid #e5e7eb;}
    #formModal .modal-body{padding:1rem;max-height:70vh;overflow:auto;}
    #formModal .close{appearance:none;border:0;background:#f1f5f9;border-radius:8px;padding:.3rem .55rem;font-weight:700;cursor:pointer;}
  `;
  const style = document.createElement('style');
  style.textContent = css;
  document.head.appendChild(style);

  m = document.createElement('div');
  m.id = 'formModal';
  m.innerHTML = `
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle" style="margin:0;font-weight:800;">Editar entrada</h3>
        <button class="close" type="button" onclick="closeFormModal()">√ó</button>
      </div>
      <div class="modal-body"><div style="color:#64748b">Cargando editor‚Ä¶</div></div>
    </div>
  `;
  document.body.appendChild(m);
  return m;
}
function openFormWithHTML(html, title) {
  const m = ensureModal();
  m.querySelector('#modalTitle').textContent = title || 'Editar entrada';
  m.querySelector('.modal-body').innerHTML = html;
  m.style.display = 'block';
}
function closeFormModal() {
  const m = document.getElementById('formModal');
  if (m) m.style.display = 'none';
}

/* ---------- Quill init ---------- */
function initQuillEditors(root = document){
  root.querySelectorAll('[id^="editor_definicion_"]').forEach(div => {
    const n = div.id.replace('editor_definicion_', '');
    const hidden = (root.getElementById ? root.getElementById('definicion_' + n)
                                        : document.getElementById('definicion_' + n));
    if (div.__quill) return; // already initialized
    const q = new Quill('#' + div.id, {
      theme: 'snow',
      modules: {
        toolbar: [
          ['bold','italic','underline','strike'],
          [{ list:'ordered' }, { list:'bullet' }],
          [{ color:[] }, { background:[] }],
          ['link','clean']
        ]
      }
    });
    div.__quill = q;
    if (hidden) q.on('text-change', () => { hidden.value = q.root.innerHTML; });
  });
}

/* ---------- Examples: builder + behaviors ---------- */
function buildExampleRow(n){
  const div = document.createElement('div');
  div.className = 'example-item';
  div.innerHTML = `
    <label>Oraci√≥n (ES)</label>
    <textarea name="example_sentence_${n}[]" rows="2"></textarea>

    <label>Traducci√≥n (EN)</label>
    <textarea name="example_translation_${n}[]" rows="2"></textarea>

    <label>Audio del ejemplo</label>
    <input type="file" name="example_audio_${n}[]" accept="audio/*">

    <label>Fuente</label>
    <select name="example_source_kind_${n}[]" class="source-kind">
      <option value="">-- Seleccionar --</option>
      <option value="pelicula">Pel√≠cula</option>
      <option value="serie">Serie</option>
      <option value="redes">Redes sociales</option>
      <option value="cancion">Canci√≥n</option>
      <option value="otro">Otro</option>
    </select>

    <div class="source-fields source-pelicula" style="display:none;">
      <label>T√≠tulo</label>
      <input type="text" name="example_source_title_${n}[]">
      <label>A√±o</label>
      <input type="text" name="example_source_year_${n}[]">
    </div>

    <div class="source-fields source-serie" style="display:none;">
      <label>T√≠tulo</label>
      <input type="text" name="example_source_title_${n}[]">
      <label>A√±o</label>
      <input type="text" name="example_source_year_${n}[]">
      <label>Temporada</label>
      <input type="text" name="example_source_season_${n}[]">
      <label>Episodio</label>
      <input type="text" name="example_source_episode_${n}[]">
    </div>

    <div class="source-fields source-redes" style="display:none;">
      <label>Usuario/Handle</label>
      <input type="text" name="example_source_handle_${n}[]">
      <label>URL</label>
      <input type="text" name="example_source_url_${n}[]">
    </div>

    <div class="source-fields source-cancion" style="display:none;">
      <label>Canci√≥n</label>
      <input type="text" name="example_source_song_${n}[]">
      <label>Artista</label>
      <input type="text" name="example_source_artist_${n}[]">
    </div>

    <div class="source-fields source-otro" style="display:none;">
      <label>Fuente</label>
      <input type="text" name="example_source_text_${n}[]">
    </div>

    <button type="button" class="remove-example">Eliminar ejemplo</button>
  `;
  return div;
}

function attachExampleBehaviors(root = document){
  if (window.__ppExamplesWired) return;
  window.__ppExamplesWired = true;

  root.addEventListener('click', e=>{
    const btn = e.target.closest('.add-example');
    if (!btn) return;
    const block = btn.closest('.sentido-block');
    const n = block?.dataset?.sentido;
    const container = block?.querySelector('.examples-container');
    if (!n || !container) return;
    container.appendChild(buildExampleRow(n));
  });

  root.addEventListener('click', e=>{
    const btn = e.target.closest('.remove-example');
    if (!btn) return;
    const item = btn.closest('.example-item');
    if (item) item.remove();
  });

  root.addEventListener('change', e=>{
    const sel = e.target.closest('select[name^="example_source_kind_"]');
    if (!sel) return;
    const ex = sel.closest('.example-item');
    if (!ex) return;
    showSourceFieldsFor(ex, sel.value);
  });
}

function showSourceFieldsFor(exampleBlock, kind){
  if (!exampleBlock) return;
  exampleBlock.querySelectorAll('.source-fields').forEach(x => x.style.display = 'none');
  const map = {
    pelicula: '.source-pelicula',
    serie:    '.source-serie',
    redes:    '.source-redes',
    cancion:  '.source-cancion',
    otro:     '.source-otro'
  };
  const section = map[kind] && exampleBlock.querySelector(map[kind]);
  if (section) section.style.display = '';
}

/* ---------- Sentidos behaviors ---------- */
function attachSentidoBehaviors(root = document){
  if (window.__ppSentidosWired) return;
  window.__ppSentidosWired = true;

  root.addEventListener('click', (e) => {
    const btn = e.target.closest('#addSentidoBtn');
    if (!btn) return;

    const form = root.getElementById('addEntryForm');
    const base = form?.querySelector('.sentido-block[data-sentido="1"]');
    if (!base) return;

    const current = [...form.querySelectorAll('.sentido-block')];
    const n = current.length + 1;

    const clone = base.cloneNode(true);
    clone.dataset.sentido = String(n);
    const h4 = clone.querySelector('h4');
    if (h4) h4.textContent = `Sentido ${n}`;

    clone.querySelectorAll('[id],[name],[for]').forEach(el => {
      ['id','name','for'].forEach(attr => {
        const val = el.getAttribute && el.getAttribute(attr);
        if (!val) return;
        el.setAttribute(attr, val.replace(/(_|-)1(\[\])?/g, `$1${n}$2`));
      });
      if ('value' in el) el.value = '';
      if (el.tagName === 'TEXTAREA') el.textContent = '';
      if (el.tagName === 'SELECT') el.selectedIndex = 0;
    });

    const qDiv = clone.querySelector(`#editor_definicion_${n}`);
    if (qDiv) { qDiv.innerHTML = ''; delete qDiv.__quill; }
    const hidden = clone.querySelector(`#definicion_${n}`);
    if (hidden) hidden.value = '';

    const exContainer = clone.querySelector('.examples-container');
    if (exContainer) {
      exContainer.querySelectorAll('.example-item').forEach(x => x.remove());
      exContainer.appendChild(buildExampleRow(n));
    }

    root.getElementById('extra-sentidos')?.appendChild(clone);
    initQuillEditors(root);
  });

  root.addEventListener('click', (e) => {
    const btn = e.target.closest('.remove-sentido');
    if (!btn) return;

    const block = btn.closest('.sentido-block');
    const form = btn.closest('#addEntryForm');
    if (!block || !form) return;

    const blocks = [...form.querySelectorAll('.sentido-block')];
    if (blocks.length <= 1) { alert('Debe haber al menos un sentido.'); return; }

    block.remove();

    const remain = [...form.querySelectorAll('.sentido-block')];
    remain.forEach((b, i) => {
      const n = i + 1;
      b.dataset.sentido = String(n);
      const h = b.querySelector('h4');
      if (h) h.textContent = `Sentido ${n}`;
      b.querySelectorAll('[id],[name],[for]').forEach(el => {
        ['id','name','for'].forEach(attr => {
          const val = el.getAttribute && el.getAttribute(attr);
          if (!val) return;
          el.setAttribute(attr, val.replace(/(_|-)\d+(\[\])?$/g, `$1${n}$2`));
        });
      });
    });
  });
}

/* ---------- Prefill + submit ---------- */
function prefillFromEntry(entry) {
  const form = document.getElementById('addEntryForm');
  if (!form) { console.warn('addEntryForm not found'); return; }

  const setVal = (sel, val, root=form) => {
    const el = root.querySelector(sel);
    if (el) el.value = val ?? '';
  };

  setVal('[name="word"]', entry.word || '');
  const v = entry.variants || {};
  setVal('[name="variant_ms"]',          (v.ms || []).join(', '));
  setVal('[name="variant_mp"]',          (v.mp || []).join(', '));
  setVal('[name="variant_fs"]',          (v.fs || []).join(', '));
  setVal('[name="variant_fp"]',          (v.fp || []).join(', '));
  setVal('[name="variant_diminutivo"]',  (v.diminutivo || []).join(', '));
  setVal('[name="variant_aumentativo"]', (v.aumentativo || []).join(', '));

  const senses = Array.isArray(entry.senses) ? entry.senses : [];
  const targetCount = Math.max(1, senses.length);

  const addSenseBtn = document.getElementById('addSentidoBtn');
  const currentBlocks = () => document.querySelectorAll('.sentido-block').length;
  while (addSenseBtn && currentBlocks() < targetCount) addSenseBtn.click();

  senses.forEach((s, i) => {
    const n = i + 1;
    const block = document.querySelector(`.sentido-block[data-sentido="${n}"]`);
    if (!block) return;

    const defHTML = s.definition || '';
    const hiddenDef = block.querySelector(`#definicion_${n}`);
    if (hiddenDef) hiddenDef.value = defHTML;

    const quillDiv = document.getElementById(`editor_definicion_${n}`);
    (function setDefIntoQuill(attempts = 0){
      const q = quillDiv && quillDiv.__quill;
      if (!q) { if (attempts < 40) setTimeout(()=>setDefIntoQuill(attempts+1), 25); return; }
      q.clipboard.dangerouslyPasteHTML(defHTML || '');
      if (hiddenDef) {
        q.off?.('text-change');
        q.on('text-change', () => { hiddenDef.value = q.root.innerHTML; });
      }
    })();

    setVal(`#clase_${n}, [name="clase_${n}"]`,                 (s.tag_word_class || []).join(', '), block);
    setVal(`#etiquetas_${n}, [name="etiquetas_${n}"]`,         (s.tag_general || []).join(', '),    block);
    setVal(`#equivalentes_${n}, [name="equivalentes_${n}"]`,   (s.equivalents || []).join(', '),    block);

    const examples = Array.isArray(s.examples) ? s.examples : [];
    const container = block.querySelector('.examples-container');
    if (container) container.innerHTML = '';

    examples.forEach(ex => {
      const exBlock = buildExampleRow(n);
      (container || block).appendChild(exBlock);

      const esField = exBlock.querySelector(`textarea[name="example_sentence_${n}[]"]`);
      const enField = exBlock.querySelector(`textarea[name="example_translation_${n}[]"]`);
      if (esField) esField.value = ex.es || '';
      if (enField) enField.value = ex.en || '';

      const kindSel = exBlock.querySelector(`select[name="example_source_kind_${n}[]"]`);
      const src = ex?.source || {};
      let kind = (src.kind || '').toLowerCase();

      if (!kind) {
        if (src.season || src.episode)      kind = 'serie';
        else if (src.song || src.artist)     kind = 'cancion';
        else if (src.handle || src.url)      kind = 'redes';
        else if (src.title && src.year)      kind = 'pelicula';
        else if (src.text)                   kind = 'otro';
        else                                 kind = '';
      }

      if (kindSel) {
        kindSel.value = kind;
      }
      showSourceFieldsFor(exBlock, kind);

      if (kind === 'pelicula') {
        const wrap = exBlock.querySelector('.source-pelicula');
        if (wrap) {
          const t = wrap.querySelector(`[name="example_source_title_${n}[]"]`);
          const y = wrap.querySelector(`[name="example_source_year_${n}[]"]`);
          if (t) t.value = ex?.source?.title || '';
          if (y) y.value = ex?.source?.year  || '';
        }
      } else if (kind === 'serie') {
        const w = exBlock.querySelector('.source-serie');
        if (w) {
          const t = w.querySelector(`[name="example_source_title_${n}[]"]`);
          const y = w.querySelector(`[name="example_source_year_${n}[]"]`);
          const s = w.querySelector(`[name="example_source_season_${n}[]"]`);
          const e = w.querySelector(`[name="example_source_episode_${n}[]"]`);
          if (t) t.value = ex?.source?.title   || '';
          if (y) y.value = ex?.source?.year    || '';
          if (s) s.value = ex?.source?.season  || '';
          if (e) e.value = ex?.source?.episode || '';
        }
      } else if (kind === 'redes') {
        const w = exBlock.querySelector('.source-redes');
        if (w) {
          const h = w.querySelector(`[name="example_source_handle_${n}[]"]`);
          const u = w.querySelector(`[name="example_source_url_${n}[]"]`);
          if (h) h.value = ex?.source?.handle || '';
          if (u) u.value = ex?.source?.url    || '';
        }
      } else if (kind === 'cancion') {
        const w = exBlock.querySelector('.source-cancion');
        if (w) {
          const song   = w.querySelector(`[name="example_source_song_${n}[]"]`);
          const artist = w.querySelector(`[name="example_source_artist_${n}[]"]`);
          if (song)   song.value   = ex?.source?.song   || '';
          if (artist) artist.value = ex?.source?.artist || '';
        }
      } else if (kind === 'otro') {
        const w = exBlock.querySelector('.source-otro');
        if (w) {
          const txt = w.querySelector(`[name="example_source_text_${n}[]"]`);
          if (txt) txt.value = ex?.source?.text || '';
        }
      }
    });
  });

  if (senses.length === 0) {
    const block = document.querySelector('.sentido-block[data-sentido="1"]');
    if (block) {
      const hidden = block.querySelector('#definicion_1');
      if (hidden) hidden.value = '';
      const qDiv = block.querySelector('#editor_definicion_1');
      if (qDiv?.__quill) qDiv.__quill.root.innerHTML = '';
    }
  }
}

function wireEditSubmit(originalWord){
  const form = document.getElementById('addEntryForm');
  if (!form) return;
  if (form.__wiredSubmit) return;
  form.__wiredSubmit = true;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    const word = (form.word?.value || '').trim();
    if (!word) { alert('La palabra es requerida'); return; }

    const variants = {
      ms: (form.variant_ms?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      mp: (form.variant_mp?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      fs: (form.variant_fs?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      fp: (form.variant_fp?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      diminutivo: (form.variant_diminutivo?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
      aumentativo: (form.variant_aumentativo?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
    };

    let hasAnyDefinition = false;
    const senses = [];

    document.querySelectorAll('.sentido-block').forEach((block, idx) => {
      const n = block.dataset.sentido;

      let defHTML = (document.getElementById(`definicion_${n}`)?.value || '').trim();
      if (!defHTML) {
        const qDiv = document.getElementById(`editor_definicion_${n}`);
        if (qDiv?.__quill) {
          defHTML = (qDiv.__quill.root.innerHTML || '').trim();
        } else if (qDiv) {
          defHTML = (qDiv.innerHTML || '').trim();
        }
      }

      const defText = (defHTML || '')
        .replace(/<[^>]*>/g, '')
        .replace(/&nbsp;/g, ' ')
        .trim();

      if (defText) hasAnyDefinition = true;

      const sense = {
        id: `s${idx+1}`,
        tag_word_class: (form[`clase_${n}`]?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        tag_general:    (form[`etiquetas_${n}`]?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        definition: defHTML,
        equivalents:   (form[`equivalentes_${n}`]?.value || '').split(',').map(s=>s.trim()).filter(Boolean),
        see_also: [],
        examples: []
      };

      block.querySelectorAll('.example-item').forEach(ex => {
        const es   = ex.querySelector(`textarea[name="example_sentence_${n}[]"]`)?.value.trim() || '';
        const en   = ex.querySelector(`textarea[name="example_translation_${n}[]"]`)?.value.trim() || '';

        let kind = ex.querySelector(`select[name="example_source_kind_${n}[]"]`)?.value || '';
        if (!kind) {
          const kinds = ['pelicula','serie','redes','cancion','otro'];
          for (const k of kinds) {
            const sec = ex.querySelector(`.source-${k}`);
            if (sec && sec.style.display !== 'none') { kind = k; break; }
          }
        }

        const source = {};
        if (kind) {
          source.kind = kind;
          if (kind === 'pelicula') {
            const w = ex.querySelector('.source-pelicula');
            source.title = w?.querySelector(`[name="example_source_title_${n}[]"]`)?.value || '';
            source.year  = w?.querySelector(`[name="example_source_year_${n}[]"]`)?.value  || '';
          } else if (kind === 'serie') {
            const w = ex.querySelector('.source-serie');
            source.title   = w?.querySelector(`[name="example_source_title_${n}[]"]`)?.value   || '';
            source.year    = w?.querySelector(`[name="example_source_year_${n}[]"]`)?.value    || '';
            source.season  = w?.querySelector(`[name="example_source_season_${n}[]"]`)?.value  || '';
            source.episode = w?.querySelector(`[name="example_source_episode_${n}[]"]`)?.value || '';
          } else if (kind === 'redes') {
            source.handle = ex.querySelector(`[name="example_source_handle_${n}[]"]`)?.value || '';
            source.url    = ex.querySelector(`[name="example_source_url_${n}[]"]`)?.value    || '';
          } else if (kind === 'cancion') {
            source.song   = ex.querySelector(`[name="example_source_song_${n}[]"]`)?.value   || '';
            source.artist = ex.querySelector(`[name="example_source_artist_${n}[]"]`)?.value || '';
          } else if (kind === 'otro') {
            source.text = ex.querySelector(`[name="example_source_text_${n}[]"]`)?.value || '';
          }
        }

        const exObj = { es, en, source };
        const fileInput = ex.querySelector(`input[type="file"][name="example_audio_${n}[]"]`);
        if (fileInput?.files?.length) {
          const orig = fileInput.files[0].name;
          const safe = orig.normalize('NFKD').replace(/[^\w.\-]+/g, '_');
          const serverSlug = word.toLowerCase()
            .replace(/√±/g,'n')
            .replace(/[^\p{L}\p{N} ]/gu,'-')
            .replace(/ /g,'-');
          exObj.audio = `/static/audio/examples/${serverSlug}/${safe}`;
        }

        if (es || en || Object.keys(source).length) sense.examples.push(exObj);
      });

      senses.push(sense);
    });

    if (!hasAnyDefinition) {
      alert('Agreg√° al menos un sentido con definici√≥n.');
      return;
    }

    const fd = new FormData();
    const effectiveOriginal = (originalWord && originalWord.trim()) ? originalWord.trim() : word;
    fd.set('original_word', effectiveOriginal);
    fd.set('word', word);
    fd.set('variants', JSON.stringify(variants));
    fd.set('senses', JSON.stringify(senses));

    if (form.audio_word?.files?.length) {
      fd.set('audio_word', form.audio_word.files[0]);
    }

    form.querySelectorAll('input[type="file"][name^="example_audio_"]').forEach(inp => {
      [...(inp.files || [])].forEach(f => fd.append(inp.name.replace('[]',''), f));
    });

    try {
      const isNew = !(originalWord && originalWord.trim());
      const url   = isNew
        ? `/admin/glosario/{{ country_code }}/add`
        : `/admin/glosario/{{ country_code }}/update`;

      const res = await fetch(url, { method:'POST', body: fd });
      let data = {};
      try { data = await res.json(); } catch (_) {}

      if (!res.ok || !data.success) throw new Error(data.error || `HTTP ${res.status}`);

      alert(isNew ? '‚úÖ Entrada creada' : '‚úÖ Entrada actualizada');
      // Refresh just the partial after save
      try {
        const container = document.getElementById('country-content');
        if (container) {
          const r = await fetch(`/admin/glosario/{{ country_code }}?partial=1`, { headers: { 'X-Requested-With': 'fetch' }});
          container.innerHTML = await r.text();
          return;
        }
      } catch(e){}
      location.reload();
    } catch (err) {
      console.error(err);
      alert('‚ùå Error al actualizar: ' + err.message);
    }
  });
}

/* ---------- Open editor ---------- */
async function editEntry(word, entry) {
  try {
    const resp = await fetch("{{ url_for('static', filename='admin_forms/add_entry_form.html') }}", { cache: "no-store" });
    const html = await resp.text();
    openFormWithHTML(html, `Editar: ${word}`);
    setTimeout(() => {
      attachExampleBehaviors(document);
      attachSentidoBehaviors(document);
      initQuillEditors(document);
      prefillFromEntry(entry || { word });
      wireEditSubmit(word);
    }, 0);
  } catch (e) {
    console.error(e);
    alert("No se pudo cargar el editor.");
  }
}

/* ---------- New entry ---------- */
document.getElementById('btnNewEntry')?.addEventListener('click', async () => {
  try {
    const resp = await fetch("{{ url_for('static', filename='admin_forms/add_entry_form.html') }}", { cache: "no-store" });
    const html = await resp.text();
    openFormWithHTML(html, "Nueva entrada");
    setTimeout(() => {
      attachExampleBehaviors(document);
      attachSentidoBehaviors(document);
      initQuillEditors(document);
      wireEditSubmit('');
    }, 0);
  } catch (e) {
    console.error(e);
    alert("No se pudo cargar el editor.");
  }
});

/* ---------- Delete entry ---------- */
async function deleteEntry(btn, word) {
  if (!word) return;
  if (!confirm(`¬øEliminar "${word}" del glosario? Esta acci√≥n no se puede deshacer.`)) return;

  try {
    const res = await fetch(`/admin/glosario/{{ country_code }}/delete`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ word })
    });
    const data = await res.json();
    if (!res.ok || !data.success) throw new Error(data.error || 'No se pudo eliminar');

    const card = btn.closest('.admin-entry-card');
    if (card) card.remove();

    const p = document.querySelector('p[style*="Total:"]');
    if (p) {
      const grid = document.querySelector('.admin-glossary-grid');
      const count = grid ? grid.querySelectorAll('.admin-entry-card').length : 0;
      p.textContent = `Total: ${count} entradas`;
    }

    alert('üóëÔ∏è Entrada eliminada');
  } catch (err) {
    console.error(err);
    alert('‚ùå Error al eliminar: ' + err.message);
  }
}
</script>