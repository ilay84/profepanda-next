{% extends "base.html" %}

{% block title %}Admin ‚Äî Ejercicios{% endblock %}

{% block admin_nav %}
  {% include "_admin_bar.html" %}
{% endblock %}

{% block content %}
<h2 style="display:flex;align-items:center;gap:.5rem;margin:.25rem 0 1rem;">
  üß© Administrar Ejercicios
</h2>

<style>
  .ex-admin-wrap { display:grid; grid-template-columns: 320px 1fr; gap:1rem; }
  @media (max-width: 900px){ .ex-admin-wrap { grid-template-columns: 1fr; } }

  .ex-panel {
    background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden;
    box-shadow:0 4px 14px rgba(0,0,0,.05);
  }
  .ex-panel header {
    padding:.75rem 1rem; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;
    background:#f8fafc;
  }
  .ex-panel header h3 { margin:0; font-size:1rem; color:#0f172a; }
  .ex-panel .ex-body { padding:1rem; }

  .ex-list { display:flex; flex-direction:column; gap:.5rem; }
  .ex-item {
    border:1px solid #e5e7eb; border-radius:12px; padding:.6rem .75rem; background:#fff;
    display:flex; flex-direction:column; gap:.25rem;
  }
  .ex-item .ex-title { font-weight:600; color:#0f172a; }
  .ex-item .ex-meta { font-size:.85rem; color:#64748b; display:flex; gap:.5rem; flex-wrap:wrap; }
  .ex-item .ex-meta .pill { background:#f1f5f9; border:1px solid #e2e8f0; padding:.1rem .5rem; border-radius:999px; }

  .btn {
    appearance:none;
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    border:1px solid #cbd5e1;
    background:#fff;
    color:#0f172a;
    padding:.5rem .75rem;
    border-radius:10px;
    cursor:pointer;
    line-height:1.1;
    text-decoration:none;
    font-weight:600;
  }
  .btn:hover { background:#f8fafc; text-decoration:none; }
  .btn-primary {
    border-color:#0ea5e9; background:#0ea5e9; color:white;
  }
  .btn-primary:hover { filter:brightness(.95); }

    .btn-secondary {
    background:#f8fafc;
    border-color:#cbd5e1;
    color:#0f172a;
  }
  .btn-secondary:hover { background:#eef2f7; }


  .ex-empty { color:#64748b; font-size:.95rem; }
  .tiny { font-size:.85rem; color:#64748b; }
  .muted { color:#64748b; }
  .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .row > * { margin: .15rem 0; }

  /* Radio pill buttons for TF */
  .tf-radio label {
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    border:1px solid #cbd5e1;
    border-radius:999px;
    padding:.3rem .75rem;
    cursor:pointer;
    font-size:.9rem;
    background:#f8fafc;
    transition:all .15s ease;
  }
  .tf-radio input[type="radio"] {
    accent-color:#0ea5e9;
  }
  .tf-radio label:hover {
    background:#e0f2fe;
    border-color:#0ea5e9;
  }
  .tf-radio input[type="radio"]:checked + span {
    font-weight:600;
    color:#0ea5e9;
  }

  /* Modal */
  .ex-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
  }
  .ex-modal.open { display: block; }
  .ex-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    backdrop-filter: blur(2px);
  }
  .ex-modal-panel {
    position: relative;
    margin: 4vh auto;
    max-width: 980px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.25);
    overflow: hidden;
  }
  .ex-modal-panel header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:.85rem 1rem;
    border-bottom:1px solid #e5e7eb;
    background:#f8fafc;
  }
  .ex-modal-panel header h3 {
    margin:0;
    font-size:1rem;
    color:#0f172a;
  }
  .ex-modal-body {
    padding:1rem;
    max-height: 70vh;
    overflow:auto;
  }
  .ex-modal-close {
    appearance: none;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    font-weight: 600;
    line-height: 1;
    cursor: pointer;
    color: #64748b;
  }
    .ex-modal-close:hover {
    color: #0f172a;
    background: transparent;
  }

  /* Modal */
  .ex-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
  }
  .ex-modal.open { display: block; }
  .ex-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    backdrop-filter: blur(2px);
  }
  .ex-modal-panel {
    position: relative;
    margin: 4vh auto;
    max-width: 980px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.25);
    overflow: hidden;
  }
  .ex-modal-panel header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:.85rem 1rem;
    border-bottom:1px solid #e5e7eb;
    background:#f8fafc;
  }
  .ex-modal-panel header h3 {
    margin:0;
    font-size:1rem;
    color:#0f172a;
  }
  .ex-modal-body {
    padding:1rem;
    max-height: 70vh;
    overflow:auto;
  }
  .ex-modal-close {
    appearance:none;
    border:1px solid #cbd5e1;
    background:#fff;
    border-radius:10px;
    padding:.4rem .6rem;
    cursor:pointer;
  }
  .ex-modal-close:hover {
    background:#f1f5f9;
  }
</style>

<div class="ex-admin-wrap">

  <!-- Left: Library -->
  <section class="ex-panel">
    <header>
      <h3>Biblioteca</h3>
      <form method="get" action="{{ url_for('admin.admin_exercises_library') }}" class="row" style="margin:0;">
        <button type="submit" class="btn tiny" title="Refrescar">‚Üª Refrescar</button>
      </form>
    </header>
    <div class="ex-body">
      {% if index and index.exercises and index.exercises|length > 0 %}
        <div class="ex-list">
          {% for ex in index.exercises %}
            <div class="ex-item">
              <div class="ex-title">{{ ex.title or "(Sin t√≠tulo)" }}</div>
              <div class="ex-meta">
                <span class="pill">ID: {{ ex.id }}</span>
                <span class="pill">Tipo: {{ ex.type|upper }}</span>
                {% if ex.pinned_version %}<span class="pill">Fijada: v{{ ex.pinned_version }}</span>{% endif %}
                {% if ex.versions and ex.versions|length %}
                  <span class="pill">Vers.: {{ ex.versions|length }}</span>
                {% endif %}
              </div>
              <div class="row">
                <a class="btn tiny" href="{{ url_for('admin.admin_exercises_new') }}?type={{ ex.type or 'tf' }}&id={{ ex.id }}">‚úèÔ∏è Editar</a>
                <button class="btn tiny" type="button" data-ex-id="{{ ex.id }}">üóëÔ∏è Eliminar</button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="ex-empty">No hay ejercicios todav√≠a.</p>
      {% endif %}
    </div>
  </section>

  <!-- Right: Create / Preview Shell -->
  <section class="ex-panel">
    <header>
      <h3>Nuevo ejercicio:</h3>
    </header>
    <div class="row" style="padding: .75rem 1rem; border-bottom:1px solid #e5e7eb; gap:.5rem; flex-wrap:wrap;">
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=tf">+ ¬øVerdadero o falso?</a>
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=mcq">+ Respuesta m√∫ltiple</a>
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=cloze">+ Llenar los huecos</a>
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=dnd_text">+ Arrastrar y soltar (texto)</a>
    </div>
    <div class="ex-body">
      <hr style="margin:1rem 0;border:none;border-top:1px solid #e5e7eb;">
      <div>
        <div class="tiny muted">Total ejercicios: <strong>{{ (index.exercises or [])|length }}</strong></div>
      </div>
    </div>
  </section>

  <!-- Modal: Exercise Builder -->
  <div id="ex-modal" class="ex-modal{% if create_type %} open{% endif %}">
    <div class="ex-modal-backdrop" id="ex-modal-backdrop"></div>
    <div class="ex-modal-panel">
      <header>
        <h3>{% if edit_ex %}Editar ejercicio{% else %}Nuevo ejercicio{% endif %}</h3>
        <button class="ex-modal-close" type="button" id="ex-modal-close" aria-label="Cerrar">√ó</button>
      </header>
      <div class="ex-modal-body">
        {% if create_type == 'tf' %}
        <form id="ex-tf-form" class="tiny" action="{{ url_for('admin.admin_exercises_save') }}" method="post" style="margin-top:.25rem;">
          <input type="hidden" name="type" value="tf">
          {% if edit_ex and edit_ex.id %}
          <input type="hidden" name="id" value="{{ edit_ex.id }}">
          {% endif %}
          <!-- This hidden textarea will be filled with JSON on submit -->
          <textarea id="itemsPayload" name="items" style="display:none;"></textarea>

          <div style="display:flex;flex-direction:column;gap:.75rem;max-width:900px;">
            <label><strong>T√≠tulo del ejercicio</strong>
              <input name="title" type="text" required placeholder="Ej.: SER vs ESTAR ‚Äî T/F (A2)"
                     style="width:100%;padding:.6rem;border:1px solid #cbd5e1;border-radius:8px;">
            </label>

            <!-- Items builder -->
            <div>
              <div class="row" style="justify-content:space-between;align-items:center;">
                <div class="muted" style="font-weight:600;">Preguntas (Verdadero/Falso)</div>
                <button type="button" id="btnAddItem" class="btn">+ Agregar pregunta</button>
              </div>
              <div id="itemsList" style="display:flex;flex-direction:column;gap:.75rem;margin-top:.75rem;"></div>
            </div>

            <div class="row">
              <button class="btn btn-primary" type="submit">Guardar versi√≥n</button>
              <button class="btn btn-secondary" type="button" id="btnCancel">Cancelar</button>
              <span class="tiny muted">Se guardar√° en <code>data/exercises/</code> y se actualizar√° <code>exercises.index.json</code>.</span>
            </div>
          </div>
        </form>

        <script>
          (function(){
            const itemsList = document.getElementById('itemsList');
            const btnAdd = document.getElementById('btnAddItem');
            const form = document.getElementById('ex-tf-form');
            const payload = document.getElementById('itemsPayload');

            const btnCancel = document.getElementById('btnCancel');
            const modal = document.getElementById('ex-modal');
            const modalClose = document.getElementById('ex-modal-close');
            const modalBackdrop = document.getElementById('ex-modal-backdrop');

            // Simple helper to create elements
            function el(tag, attrs={}, children=[]){
              const node = document.createElement(tag);
              Object.entries(attrs).forEach(([k,v])=>{
                if(k === 'class') node.className = v;
                else if(k === 'style') node.setAttribute('style', v);
                else node.setAttribute(k, v);
              });
              (Array.isArray(children)?children:[children]).forEach(c=>{
                if(typeof c === 'string') node.appendChild(document.createTextNode(c)); else if(c) node.appendChild(c);
              });
              return node;
            }

            function itemCard(idx){
              const wrap = el('div', {class:'tf-item', style:'border:1px solid #e5e7eb;border-radius:12px;padding:.75rem;background:#fff;'});
              const header = el('div', {style:'display:flex;justify-content:space-between;align-items:center;margin-bottom:.5rem;'});
              header.appendChild(el('div', {class:'muted'}, [`Pregunta #${idx+1}`]));
              const btnDel = el('button', {type:'button', class:'btn'}, 'Eliminar');
              btnDel.addEventListener('click', () => { wrap.remove(); isDirty = true; });
              header.appendChild(btnDel);

              const prompt = el('textarea', {
                placeholder: 'Enunciado de la afirmaci√≥n‚Ä¶',
                rows:'2',
                style:'width:100%;padding:.5rem;border:1px solid #cbd5e1;border-radius:8px;margin:.25rem 0;'
              });

              const answerRow = el('div', {class:'row tf-radio', style:'gap:1rem;align-items:center;margin:.25rem 0;'});
              const radioName = `ans-${crypto.randomUUID()}`;
              const trueOpt = el('label', {}, [
                el('input', {type:'radio', name:radioName, value:'true'}),
                el('span', {}, 'Verdadero')
              ]);
              const falseOpt = el('label', {}, [
                el('input', {type:'radio', name:radioName, value:'false'}),
                el('span', {}, 'Falso')
              ]);
              answerRow.appendChild(el('div', {class:'muted'}, 'Respuesta correcta:'));

              // Ensure both radios share the same name group
              falseOpt.firstChild.name = trueOpt.firstChild.name;
              answerRow.appendChild(trueOpt);
              answerRow.appendChild(falseOpt);

              const fbOk = el('textarea', {
                placeholder:'Feedback para respuesta correcta (opcional)',
                rows:'2',
                style:'width:100%;padding:.5rem;border:1px solid #cbd5e1;border-radius:8px;margin:.25rem 0;'
              });
              const fbBad = el('textarea', {
                placeholder:'Feedback para respuesta incorrecta (opcional)',
                rows:'2',
                style:'width:100%;padding:.5rem;border:1px solid #cbd5e1;border-radius:8px;margin:.25rem 0;'
              });
              const hint = el('textarea', {
                placeholder:'Pista (opcional; si hay pista, el bot√≥n ‚ÄúVer pista‚Äù aparecer√°)',
                rows:'2',
                style:'width:100%;padding:.5rem;border:1px solid #cbd5e1;border-radius:8px;margin:.25rem 0;'
              });

              wrap.appendChild(header);
              wrap.appendChild(prompt);
              wrap.appendChild(answerRow);
              wrap.appendChild(fbOk);
              wrap.appendChild(fbBad);
              wrap.appendChild(hint);

              // expose getters for serialization
              wrap._get = () => {
                const ansTrue = trueOpt.querySelector('input').checked;
                const ansFalse = falseOpt.querySelector('input').checked;
                const hasAnswer = ansTrue || ansFalse;
                return {
                  prompt: prompt.value.trim(),
                  answer: hasAnswer ? ansTrue : null,
                  feedback_correct: fbOk.value.trim() || null,
                  feedback_incorrect: fbBad.value.trim() || null,
                  hint: hint.value.trim() || null
                };
              };
              return wrap;
            }

            // Dirty tracking
            let isDirty = false;
            form.addEventListener('input', () => { isDirty = true; });
            btnAdd.addEventListener('click', () => { isDirty = true; });

            function renumber(){
              const cards = [...itemsList.querySelectorAll('.tf-item')];
              cards.forEach((c,i)=>{
                const title = c.querySelector('.muted');
                if(title) title.textContent = `Pregunta #${i+1}`;
              });
            }

            btnAdd.addEventListener('click', ()=>{
              const idx = itemsList.querySelectorAll('.tf-item').length;
              itemsList.appendChild(itemCard(idx));
              renumber();
            });

            {% if edit_ex %}
            // Prefill form with existing exercise data
            const ex = {{ edit_ex|tojson }};
            if (ex && ex.title) {
              form.querySelector("input[name=title]").value = ex.title;
            }
            if (Array.isArray(ex.items)) {
              ex.items.forEach((it, idx) => {
                const card = itemCard(idx);
                itemsList.appendChild(card);
                // fill values
                card.querySelector("textarea").value = it.prompt || "";
                const radios = card.querySelectorAll("input[type=radio]");
                radios.forEach(r => { if ((r.value === "true") === !!it.answer) r.checked = true; });
                const ta = card.querySelectorAll("textarea");
                if (ta[1]) ta[1].value = it.feedback_correct || "";
                if (ta[2]) ta[2].value = it.feedback_incorrect || "";
                if (ta[3]) ta[3].value = it.hint || "";
              });
              renumber();
            }
            {% else %}
            // Seed with one empty item for convenience
            btnAdd.click();
            {% endif %}

            // Cancel = close modal or go back to library
            function closeModal(){
              modal.classList.remove('open');
              // Optional: clean the query string when closing
              if (window.history && window.history.replaceState) {
                const url = new URL(window.location);
                url.searchParams.delete('type');
                url.searchParams.delete('id');
                window.history.replaceState({}, '', url.pathname + url.search);
              }
            }
            btnCancel.addEventListener('click', () => {
              if (isDirty && !confirm('¬øDescartar cambios no guardados?')) return;
              closeModal();
            });
            modalClose.addEventListener('click', () => {
              if (isDirty && !confirm('¬øDescartar cambios no guardados?')) return;
              closeModal();
            });
            modalBackdrop.addEventListener('click', () => {
              if (isDirty && !confirm('¬øDescartar cambios no guardados?')) return;
              closeModal();
            });

            // Submit
            form.addEventListener('submit', async (e)=>{
              // Build items array
              const cards = [...itemsList.querySelectorAll('.tf-item')];
              const items = cards.map(c => c._get()).filter(it => (it.prompt && it.answer !== null));
              if(items.length === 0){
                e.preventDefault();
                alert('Agreg√° al menos 1 pregunta y marc√° su respuesta correcta (V/F).');
                return;
              }
              payload.value = JSON.stringify(items);

              // Intercept submit to show a toast and stay on page
              e.preventDefault();

              // Tiny toast helper (created once)
              function showToast(msg, isErr){
                let t = document.getElementById('pp-toast');
                if(!t){
                  t = document.createElement('div');
                  t.id = 'pp-toast';
                  t.setAttribute('style',
                    'position:fixed;bottom:16px;right:16px;z-index:99999;padding:10px 12px;border-radius:10px;'+
                    'border:1px solid #e5e7eb;background:#fff;box-shadow:0 8px 30px rgba(0,0,0,.12);'+
                    'color:#0f172a;font:14px/1.2 system-ui;display:none;'
                  );
                  document.body.appendChild(t);
                }
                t.style.borderColor = isErr ? '#dc2626' : '#16a34a';
                t.style.boxShadow   = isErr ? '0 8px 30px rgba(220,38,38,.25)' : '0 8px 30px rgba(22,163,74,.25)';
                t.textContent = msg;
                t.style.display = 'block';
                setTimeout(()=>{ t.style.display = 'none'; }, 2000);
              }

              try{
                const res = await fetch(form.action, { method:'POST', body:new FormData(form) });
                const data = await res.json().catch(()=>({ success:false, error:'Respuesta inv√°lida' }));
                if(data && data.success){
                  showToast('‚úîÔ∏è Ejercicio guardado', false);
                  // brief pause, then return to library
                  setTimeout(()=>{ window.location.href = "{{ url_for('admin.admin_exercises_library') }}"; }, 600);
                }else{
                  showToast('‚ùå ' + (data && data.error ? data.error : 'Error al guardar'), true);
                }
              }catch(err){
                showToast('‚ùå Error de red al guardar', true);
              }
            });
          })();
        </script>
        {% else %}
          <p class="muted">Eleg√≠ un tipo de ejercicio para comenzar. La lista de la izquierda muestra lo que ya existe.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>
{% endblock %}