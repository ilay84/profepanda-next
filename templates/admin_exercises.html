{% extends "base.html" %}

{% block title %}Admin ‚Äî Ejercicios{% endblock %}

{% block admin_nav %}
  {% include "_admin_bar.html" %}
{% endblock %}

{% block content %}
<h2 style="display:flex;align-items:center;gap:.5rem;margin:.25rem 0 1rem;">
  üß© Administrar Ejercicios
</h2>

<style>
  .ex-admin-wrap { display:grid; grid-template-columns: 320px 1fr; gap:1rem; }
  @media (max-width: 900px){ .ex-admin-wrap { grid-template-columns: 1fr; } }

  .ex-panel {
    background:#fff; border:1px solid #e5e7eb; border-radius:14px; overflow:hidden;
    box-shadow:0 4px 14px rgba(0,0,0,.05);
  }
  .ex-panel header {
    padding:.75rem 1rem; border-bottom:1px solid #e5e7eb; display:flex; align-items:center; justify-content:space-between;
    background:#f8fafc;
  }
  .ex-panel header h3 { margin:0; font-size:1rem; color:#0f172a; }
  .ex-panel .ex-body { padding:1rem; }

  .ex-list { display:flex; flex-direction:column; gap:.5rem; }
  .ex-item {
    border:1px solid #e5e7eb; border-radius:12px; padding:.6rem .75rem; background:#fff;
    display:flex; flex-direction:column; gap:.25rem;
  }
  .ex-item .ex-title { font-weight:600; color:#0f172a; }
  .ex-item .ex-meta { font-size:.85rem; color:#64748b; display:flex; gap:.5rem; flex-wrap:wrap; }
  .ex-item .ex-meta .pill { background:#f1f5f9; border:1px solid #e2e8f0; padding:.1rem .5rem; border-radius:999px; }

  .btn {
    appearance:none;
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    border:1px solid #cbd5e1;
    background:#fff;
    color:#0f172a;
    padding:.5rem .75rem;
    border-radius:10px;
    cursor:pointer;
    line-height:1.1;
    text-decoration:none;
    font-weight:600;
  }
  .btn:hover { background:#f8fafc; text-decoration:none; }
  .btn-primary {
    border-color:#0ea5e9; background:#0ea5e9; color:white;
  }
  .btn-primary:hover { filter:brightness(.95); }

    .btn-secondary {
    background:#f8fafc;
    border-color:#cbd5e1;
    color:#0f172a;
  }
  .btn-secondary:hover { background:#eef2f7; }


  .ex-empty { color:#64748b; font-size:.95rem; }
  .tiny { font-size:.85rem; color:#64748b; }
  .muted { color:#64748b; }
  .row { display:flex; gap:.5rem; align-items:center; flex-wrap:wrap; }
  .row > * { margin: .15rem 0; }

  /* Radio pill buttons for TF */
  .tf-radio label {
    display:inline-flex;
    align-items:center;
    gap:.35rem;
    border:1px solid #cbd5e1;
    border-radius:999px;
    padding:.3rem .75rem;
    cursor:pointer;
    font-size:.9rem;
    background:#f8fafc;
    transition:all .15s ease;
  }
  .tf-radio input[type="radio"] {
    accent-color:#0ea5e9;
  }
  .tf-radio label:hover {
    background:#e0f2fe;
    border-color:#0ea5e9;
  }
  .tf-radio input[type="radio"]:checked + span {
    font-weight:600;
    color:#0ea5e9;
  }

  /* Modal */
  .ex-modal {
    position: fixed;
    inset: 0;
    z-index: 9999;
    display: none;
  }
  .ex-modal.open { display: block; }
  .ex-modal-backdrop {
    position: absolute;
    inset: 0;
    background: rgba(15, 23, 42, 0.45);
    backdrop-filter: blur(2px);
  }
  .ex-modal-panel {
    position: relative;
    margin: 4vh auto;
    max-width: 980px;
    background: #fff;
    border: 1px solid #e5e7eb;
    border-radius: 14px;
    box-shadow: 0 20px 60px rgba(0,0,0,.25);
    overflow: hidden;
  }
  .ex-modal-panel header {
    display:flex;
    align-items:center;
    justify-content:space-between;
    padding:.85rem 1rem;
    border-bottom:1px solid #e5e7eb;
    background:#f8fafc;
  }
  .ex-modal-panel header h3 {
    margin:0;
    font-size:1rem;
    color:#0f172a;
  }
  .ex-modal-body {
    padding:1rem;
    max-height: 70vh;
    overflow:auto;
  }
  .ex-modal-close {
    appearance: none;
    border: none;
    background: transparent;
    font-size: 1.5rem;
    font-weight: 600;
    line-height: 1;
    cursor: pointer;
    color: #64748b;
  }
    .ex-modal-close:hover {
    color: #0f172a;
    background: transparent;
  }

  /* Admin library preview modal: bigger panel + tall body for iframe */
  #lib-preview-modal .ex-modal-panel { max-width: 920px; }
  #lib-preview-modal .ex-modal-body { padding: 0; height: 78vh; }
  #lib-preview-iframe { width: 100%; height: 100%; border: 0; display: block; }
</style>

<div class="ex-admin-wrap">

  <!-- Left: Library -->
  <section class="ex-panel">
    <header>
      <h3>Biblioteca</h3>
      <form method="get" action="{{ url_for('admin.admin_exercises_library') }}" class="row" style="margin:0;">
        <button type="submit" class="btn tiny" title="Refrescar">‚Üª Refrescar</button>
      </form>
    </header>
    <div class="ex-body">
      {% if index and index.exercises and index.exercises|length > 0 %}
        <div class="ex-list">
          {% for ex in index.exercises %}
            <div class="ex-item">
              <div class="ex-title">{{ ex.title or "(Sin t√≠tulo)" }}</div>
              <div class="ex-meta">
                <span class="pill">ID: {{ ex.id }}</span>
                <span class="pill">Tipo: {{ ex.type|upper }}</span>
                {% if ex.pinned_version %}<span class="pill">Fijada: v{{ ex.pinned_version }}</span>{% endif %}
                {% if ex.versions and ex.versions|length %}
                  <span class="pill">Vers.: {{ ex.versions|length }}</span>
                {% endif %}
              </div>
              <div class="row">
                <button class="btn tiny" type="button" data-ex-preview="true" data-ex-id="{{ ex.id }}">üëÅÔ∏è Vista previa</button>
                <a class="btn tiny" href="{{ url_for('admin.admin_exercises_new') }}?type={{ ex.type or 'tf' }}&id={{ ex.id }}">‚úèÔ∏è Editar</a>
                <button class="btn tiny" type="button" data-ex-id="{{ ex.id }}" data-ex-delete="true">üóëÔ∏è Eliminar</button>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="ex-empty">No hay ejercicios todav√≠a.</p>
      {% endif %}
    </div>
  </section>

  <!-- Right: Create / Preview Shell -->
  <section class="ex-panel">
    <header>
      <h3>Nuevo ejercicio:</h3>
    </header>
    <div class="row" style="padding: .75rem 1rem; border-bottom:1px solid #e5e7eb; gap:.5rem; flex-wrap:wrap;">
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=tf">+ ¬øVerdadero o falso?</a>
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=mcq">+ Respuesta m√∫ltiple</a>
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=cloze">+ Llenar los huecos</a>
      <a class="btn" href="{{ url_for('admin.admin_exercises_new') }}?type=dnd_text">+ Arrastrar y soltar (texto)</a>
    </div>
    <div class="ex-body">
      <hr style="margin:1rem 0;border:none;border-top:1px solid #e5e7eb;">
      <div>
        <div class="tiny muted">Total ejercicios: <strong>{{ index.exercises | default([]) | length }}</strong></div>
      </div>
    </div>
  </section>

  <!-- Modal: Exercise Builder -->
  <div id="ex-modal" class="ex-modal{% if create_type %} open{% endif %}">
    <div class="ex-modal-backdrop" id="ex-modal-backdrop"></div>
    <div class="ex-modal-panel">
      <header>
        <h3>{% if edit_ex %}Editar ejercicio{% else %}Nuevo ejercicio{% endif %}</h3>
        <button class="ex-modal-close" type="button" id="ex-modal-close" aria-label="Cerrar">√ó</button>
      </header>
      <div class="ex-modal-body">
        {% if create_type == 'tf' %}
          {% include 'admin/builders/_tf.html' %}
          <script>
            // Safe JS/Jinja bridge
            window.PP_TF_EDIT_EX = {{ edit_ex|tojson|safe if edit_ex else "null" }};
            window.PP_ADMIN_LIBRARY_URL = "{{ url_for('admin.admin_exercises_library') }}";
          </script>
          <script defer src="{{ url_for('static', filename='js/admin/builder_tf.js') }}?v=ex1"></script>

        {% elif create_type == 'mcq' %}
          {% include 'admin/builders/_mcq.html' %}
          <script>
            // Safe JS/Jinja bridge
            window.PP_MCQ_EDIT_EX = {{ edit_ex|tojson|safe if edit_ex else "null" }};
            window.PP_ADMIN_LIBRARY_URL = "{{ url_for('admin.admin_exercises_library') }}";
          </script>
          <script defer src="{{ url_for('static', filename='js/admin/builder_mcq.js') }}?v=ex1"></script>

        {% elif create_type == 'cloze' %}
          {% include 'admin/builders/_cloze.html' %}
          <script>
            // Safe JS/Jinja bridge
            window.PP_CLOZE_EDIT_EX = {{ edit_ex|tojson|safe if edit_ex else "null" }};
            window.PP_ADMIN_LIBRARY_URL = "{{ url_for('admin.admin_exercises_library') }}";
          </script>
          <script defer src="{{ url_for('static', filename='js/admin/builder_cloze.js') }}?v=ex1"></script>

        {% else %}
          <p class="muted">
            Eleg√≠ un tipo de ejercicio para comenzar. La lista de la izquierda muestra lo que ya existe.
          </p>
        {% endif %}
      </div>
    </div>
  </div>
</div> <!-- /.ex-admin-wrap -->

<!-- Admin URLs for JS to use -->
<script>
  window.PP_ADMIN_PREVIEW_URL_TMPL = "{{ url_for('admin.admin_exercises_preview', exercise_id='__ID__') }}";
  window.PP_ADMIN_DELETE_URL_TMPL  = "{{ url_for('admin.admin_exercises_delete',  exercise_id='__ID__') }}";
  window.PP_ADMIN_LIBRARY_URL      = "{{ url_for('admin.admin_exercises_library') }}";
</script>

<!-- Hint for preview.js to auto-load the public player if missing -->
<script>
  window.PP_PUBLIC_PLAYER_SRC = "{{ url_for('static', filename='js/exercises.js') }}?v=ex1";
</script>

<!-- Admin preview wiring (modal + click handlers + rendering) -->
<script defer src="{{ url_for('static', filename='js/admin/preview.js') }}?v=ex3"></script>

<!-- Preview modal markup (your existing partial) -->
{% include "_exercise_modal.html" %}

{% endblock %}