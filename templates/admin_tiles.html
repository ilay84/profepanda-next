{% extends "base.html" %}

{% block title %}Admin ‚Äì Inicio (Tiles){% endblock %}

{% block admin_nav %}
  {% include "_admin_bar.html" %}
{% endblock %}

{% block content %}
<h2 style="display:flex;align-items:center;gap:.5rem;">
  üè† Inicio ‚Äì Tiles
</h2>
<p style="margin:.35rem 0 1rem;color:#475569;">
  Lista de tarjetas que aparecen en la p√°gina de inicio.
</p>

<style>
  .tiles-admin-grid{
    display:grid;
    grid-template-columns: repeat(3, minmax(0, 1fr));
    gap:1rem;
  }
  @media (max-width: 1024px){
    .tiles-admin-grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
  }
  @media (max-width: 640px){
    .tiles-admin-grid{ grid-template-columns: 1fr; }
  }

  .tile-admin-card{
    border:1px solid #e5e7eb;
    border-radius:14px;
    overflow:hidden;
    background:#fff;
    box-shadow:0 4px 14px rgba(0,0,0,.05);
  }
  .tile-admin-media{
    aspect-ratio:1/1;
    width:100%;
    background:#f3f4f6;
    display:flex;align-items:center;justify-content:center;
    overflow:hidden;
  }
  .tile-admin-media img{
    width:100%;height:100%;object-fit:cover;display:block;
  }
  .tile-admin-body{
    padding:.85rem 1rem 1rem;
  }
  .tile-admin-title{
    margin:0 0 .25rem 0;font-weight:700;font-size:1.05rem;color:#0f172a;
  }
  .tile-admin-meta{
    font-size:.85rem;color:#64748b;margin-bottom:.5rem;display:flex;gap:.75rem;flex-wrap:wrap;
  }
  .tile-admin-desc{
    margin:0;color:#475569;font-size:.95rem;line-height:1.35rem;
  }
  .tile-admin-actions{
    display:flex;gap:.5rem;margin-top:.85rem;flex-wrap:wrap;
  }
  .btn{
    appearance:none;border:1px solid #cbd5e1;border-radius:10px;padding:.45rem .7rem;font-size:.9rem;
    background:#fff;color:#0f172a;text-decoration:none;cursor:pointer;
    transition:background .12s ease,border-color .12s ease,transform .06s ease;
  }
  .btn:hover{ background:#f8fafc; }
  .btn:active{ transform:translateY(1px); }
  .btn-primary{ border-color:#2563eb;color:#1e40af; }
  .btn-danger{ border-color:#ef4444;color:#b91c1c; }
  .pill{
    display:inline-flex;align-items:center;gap:.35rem;
    padding:.2rem .5rem;border-radius:999px;border:1px solid #e2e8f0;background:#f8fafc;font-size:.8rem;color:#334155;
  }
</style>

<div style="margin:0 0 1rem 0;display:flex;gap:.5rem;flex-wrap:wrap;">
  <a class="btn btn-primary" href="#" title="(Pr√≥ximo paso) agregar nueva tarjeta" onclick="alert('En el pr√≥ximo paso agregamos el formulario de creaci√≥n/edici√≥n üòâ'); return false;">+ Nueva tarjeta</a>
  <a class="btn" href="{{ url_for('admin.admin_home') }}">‚Üê Volver al panel</a>
</div>

{% if not tiles %}
  <div style="padding:1rem;border:1px dashed #cbd5e1;border-radius:12px;background:#f8fafc;color:#475569;">
    No hay tiles configurados todav√≠a. Cre√° <code>data/pages/home_tiles.json</code> o us√° ‚ÄúNueva tarjeta‚Äù (lo activaremos en el pr√≥ximo paso).
  </div>
{% else %}
  <div class="tiles-admin-grid">
    {% for t in tiles %}
      <article class="tile-admin-card">
        <div class="tile-admin-media">
          {% set img = t.image|default('') %}
          {% if img.startswith('http://') or img.startswith('https://') %}
            <img src="{{ img }}" alt="{{ t.title or 'tile' }}">
          {% else %}
            <img src="{{ url_for('static', filename=img) }}" alt="{{ t.title or 'tile' }}">
          {% endif %}
        </div>
        <div class="tile-admin-body">
          <h3 class="tile-admin-title">{{ t.title or '‚Äî' }}</h3>
          <div class="tile-admin-meta">
            <span class="pill">Orden: <strong>{{ t.order|default('‚Äî') }}</strong></span>
            <span class="pill">Estado: <strong>{{ 'habilitada' if (t.enabled|default(true)) else 'deshabilitada' }}</strong></span>
            {% if t.href %}
              <span class="pill">Link: <a href="{{ t.href }}" target="_blank" rel="noopener" style="color:#2563eb;text-decoration:none;">{{ t.href }}</a></span>
            {% endif %}
          </div>
          {% set subtitle = t.subtitle or t.description or t.desc %}
          {% if subtitle %}
            <p class="tile-admin-desc">{{ subtitle }}</p>
          {% endif %}

          <div class="tile-admin-actions">
            <a href="#"
                class="btn btn-primary"
                data-tile-id="{{ (t.id or t.slug or t.title or 'unknown') }}"
                data-tile-title="{{ t.title or '' }}"
                data-tile-subtitle="{{ t.subtitle or t.desc or '' }}"
                data-tile-image="{{ t.image or '' }}"
                data-tile-href="{{ t.href or t.link or '' }}"
                onclick="openEditTile(this); return false;">
                Editar
            </a>

            <a href="#"
                class="btn btn-danger"
                data-tile-id="{{ (t.id or t.slug or t.title or 'unknown') }}"
                onclick="deleteTile(this.dataset.tileId, this); return false;">
                Borrar
            </a>
            </div>
          </div>
      </article>
    {% endfor %}
  </div>
{% endif %}
<script>
/* ========== Tiles Admin: Edit + Delete ==========
   This block adds:
   - openEditTile(btn): opens a modal with title/subtitle/image
   - save handler ‚Üí POST /admin/tiles/save (multipart/form-data)
   - deleteTile(tileId, btnEl): unchanged
   The modal is created dynamically (no extra HTML paste needed).
==================================================*/

(function initTileEditor(){
  // --- Create modal once and attach to document ---
  const modal = document.createElement('div');
  modal.id = 'tileEditModal';
  modal.className = 'modal';
  modal.style.display = 'none';
  modal.innerHTML = `
    <div class="modal-content" style="max-width:720px; height:auto; max-height:90vh;">
      <div class="modal-header">
        <h2 id="tileEditHeading" style="margin:0;">Editar tarjeta</h2>
        <span class="close" id="tileEditClose" style="cursor:pointer;">&times;</span>
      </div>
      <div class="modal-body">
        <form id="tileEditForm">
          <input type="hidden" name="id" id="tileEditId">

          <label for="tileEditImage">Imagen (opcional)</label>
          <div style="display:flex; gap:1rem; align-items:flex-start;">
            <img id="tileEditPreview" alt="Vista previa" style="width:120px; height:80px; object-fit:cover; border:1px solid #e5e7eb; border-radius:8px; background:#f1f5f9;">
            <div style="flex:1;">
              <input type="file" id="tileEditImage" name="image" accept="image/*">
              <div style="font-size:.85rem; color:#64748b; margin-top:.3rem;">
                Recomendado ~ 600√ó400 px. Si no sub√≠s una nueva, se mantiene la actual.
              </div>
            </div>
          </div>

          <label for="tileEditTitle" style="margin-top:1rem;">T√≠tulo</label>
          <input type="text" id="tileEditTitle" name="title" required>

          <label for="tileEditSubtitle" style="margin-top:.8rem;">Subt√≠tulo</label>
          <input type="text" id="tileEditSubtitle" name="subtitle" placeholder="Opcional">

          <div style="display:flex; gap:.5rem; margin-top:1rem; justify-content:flex-end;">
            <button type="button" id="tileEditCancel" class="btn">Cancelar</button>
            <button type="submit" class="btn btn-primary">Guardar</button>
          </div>
        </form>
      </div>
    </div>`;
  document.body.appendChild(modal);

  // refs
  const modalBox = modal;
  const closeX   = modal.querySelector('#tileEditClose');
  const cancel   = modal.querySelector('#tileEditCancel');
  const form     = modal.querySelector('#tileEditForm');
  const fId      = modal.querySelector('#tileEditId');
  const fTitle   = modal.querySelector('#tileEditTitle');
  const fSub     = modal.querySelector('#tileEditSubtitle');
  const fImg     = modal.querySelector('#tileEditImage');
  const fPrev    = modal.querySelector('#tileEditPreview');

  function open()  { modalBox.style.display = 'block'; }
  function close() { modalBox.style.display = 'none'; form.reset(); fPrev.removeAttribute('src'); }

  closeX.addEventListener('click', close);
  cancel.addEventListener('click', close);
  window.addEventListener('click', (e)=>{ if (e.target === modalBox) close(); });

  fImg.addEventListener('change', () => {
    const file = fImg.files && fImg.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => { fPrev.src = e.target.result || ''; };
    reader.readAsDataURL(file);
  });

  // Expose openEditTile globally (used by the new Editar button)
  window.openEditTile = function(btn){
    const d = btn.dataset || {};
    fId.value    = (d.tileId || '').trim();
    fTitle.value = d.tileTitle || '';
    fSub.value   = d.tileSubtitle || '';
    const img    = d.tileImage || '';
    if (img) fPrev.src = img.startsWith('/static') || img.startsWith('http') ? img : ('/static/' + img.replace(/^\/+/, ''));
    else fPrev.removeAttribute('src');
    open();
  };

  // Save handler ‚Üí POST /admin/tiles/save (multipart)
  form.addEventListener('submit', async (e)=>{
    e.preventDefault();
    try {
      const fd = new FormData(form);
      const resp = await fetch('/admin/tiles/save', { method:'POST', body: fd });
      const out  = await resp.json();
      if (!resp.ok || !out.success) throw new Error(out.error || `HTTP ${resp.status}`);
      close();
      // simple refresh to reflect changes
      location.reload();
    } catch (err){
      console.error(err);
      alert('No se pudo guardar la tarjeta.');
    }
  });
})();

// ======= Delete (existing) =======
async function deleteTile(tileId, btnEl){
  if (!tileId) { alert('No se pudo identificar la tarjeta.'); return; }
  tileId = tileId.toString().trim().toLowerCase().replace(/\s+/g, '-');
  if (!confirm('¬øBorrar esta tarjeta? Esta acci√≥n no se puede deshacer.')) return;
  try {
    const resp = await fetch(`/admin/home/tiles/${encodeURIComponent(tileId)}/delete`, {
      method: 'POST',
      headers: { 'Accept': 'application/json' }
    });
    const data = await resp.json();
    if (!resp.ok || !data.success) throw new Error((data && data.error) || `HTTP ${resp.status}`);
    const card = btnEl.closest('article.tile-admin-card');
    if (card) card.remove();
  } catch (err){
    console.error(err);
    alert('No se pudo borrar la tarjeta.');
  }
}
</script>
{% endblock %}